<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTI EXPERT - Suite Clinique 6087</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- SheetJS (Pour Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- DOCX & FileSaver (Pour générer le Word) -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; }
        h1, h2, h3 { font-family: 'Roboto', sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        /* Card Hover */
        .directive-item:hover { background-color: #f0f9ff; border-left: 3px solid #0ea5e9; }
        .directive-item { transition: all 0.1s ease; border-left: 3px solid transparent; }
        
        /* PTI Table Styling */
        .pti-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 10px; }
        .pti-table th { background-color: #e2e8f0; padding: 10px; text-align: left; font-weight: bold; border: 2px solid #94a3b8; text-transform: uppercase; }
        .pti-table td { padding: 10px; border: 1px solid #cbd5e1; vertical-align: top; }
        
        .role-badge {
            font-size: 0.60rem; padding: 2px 5px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-right: 6px; display: inline-block; min-width: 35px; text-align: center;
        }
        /* Role Colors */
        .role-pab { background-color: #dbeafe; color: #1e3a8a; border: 1px solid #93c5fd; } 
        .role-aux { background-color: #fce7f3; color: #831843; border: 1px solid #f9a8d4; } 
        .role-inf { background-color: #dcfce7; color: #14532d; border: 1px solid #86efac; } 
        .role-all { background-color: #f1f5f9; color: #334151; border: 1px solid #cbd5e1; } 
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            width: 6px; height: 6px; background-color: #475569; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Dashboard Card Animation */
        .dash-card { transition: all 0.2s ease-in-out; }
        .dash-card:hover { transform: translateY(-3px); }
        
        /* Tool View Container */
        .tool-view { display: none; flex-direction: column; height: 100%; overflow: hidden; background-color: #fff; }
        .tool-view.active { display: flex; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-slate-50">

    <!-- Header -->
    <header class="bg-slate-800 text-white h-14 flex items-center justify-between px-4 shadow-lg z-50 flex-none">
        <div class="flex items-center gap-3">
            <!-- Home Button -->
            <button onclick="navigateTo('dashboard')" class="bg-slate-700 hover:bg-slate-600 p-1.5 rounded transition-colors text-teal-400" title="Retour Accueil">
                <i class="fa-solid fa-house text-lg"></i>
            </button>
            <div class="h-6 w-px bg-slate-600 mx-1"></div>
            <div class="flex items-center gap-2">
                <div class="bg-teal-600 p-1 rounded text-xs"><i class="fa-solid fa-user-nurse text-white"></i></div>
                <div>
                    <h1 class="text-sm font-bold leading-tight">PTI EXPERT <span class="text-teal-400">CLINIQUE</span></h1>
                    <p class="text-[9px] text-slate-400">Assistant & Formulaire 6087 <span class="text-red-400 font-bold ml-1">(v6.0 Hub)</span></p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span id="current-tool-label" class="hidden md:inline-block text-xs font-bold text-slate-400 uppercase tracking-wider mr-2">Tableau de bord</span>
            <button onclick="openSettings()" class="flex items-center gap-2 text-xs bg-slate-700 hover:bg-slate-600 text-yellow-400 hover:text-white px-3 py-2 rounded transition-colors border border-slate-600" title="Paramètres API">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </header>

    <!-- CONTENT AREA -->
    <div id="main-container" class="flex-1 overflow-hidden relative bg-slate-100">

        <!-- 1. DASHBOARD VIEW (LANDING PAGE) -->
        <main id="view-dashboard" class="tool-view active overflow-y-auto p-4 sm:p-8 items-center bg-slate-50">
            <div class="max-w-4xl w-full space-y-8 mt-4 sm:mt-10 mx-auto">
                
                <!-- Welcome Header -->
                <div class="text-center space-y-2 mb-8">
                    <h2 class="text-3xl font-bold text-slate-800 tracking-tight">Bonjour, <span class="text-teal-600">Dave</span></h2>
                    <p class="text-slate-500 text-lg">Bienvenue sur ta station clinique PPL. Que veux-tu faire aujourd'hui?</p>
                </div>

                <!-- Zone A: AI Tools (Grid) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center">
                        <i class="fa-solid fa-microchip mr-2 text-indigo-400"></i>Outils Intelligents (Coach)
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        
                        <!-- Coach -->
                        <button onclick="navigateTo('coach')" class="dash-card p-4 rounded-lg border border-indigo-100 bg-indigo-50/50 hover:bg-indigo-50 hover:shadow-md text-left group">
                            <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-user-doctor text-2xl text-indigo-600 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded border border-indigo-200">Général</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Assistant IA</h4>
                            <p class="text-xs text-slate-600 mt-1">Questions cliniques, procédures et médicaments.</p>
                        </button>
                        
                        <!-- Malaise 6087 -->
                        <button onclick="navigateTo('malaise')" class="dash-card p-4 rounded-lg border border-teal-100 bg-teal-50/50 hover:bg-teal-50 hover:shadow-md text-left group">
                            <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-file-medical-alt text-2xl text-teal-600 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold bg-teal-100 text-teal-700 px-2 py-0.5 rounded border border-teal-200">Form. 6087</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Éval. Malaise</h4>
                            <p class="text-xs text-slate-600 mt-1">Générateur de note structurée selon le formulaire.</p>
                        </button>

                        <!-- Guide -->
                        <button onclick="navigateTo('guide')" class="dash-card p-4 rounded-lg border border-blue-100 bg-blue-50/50 hover:bg-blue-50 hover:shadow-md text-left group">
                             <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-list-check text-2xl text-blue-600 group-hover:scale-110 transition-transform"></i>
                                 <span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded border border-blue-200">Aide-mémoire</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Guide Ciblé</h4>
                            <p class="text-xs text-slate-600 mt-1">Quoi évaluer spécifiquement pour un symptôme?</p>
                        </button>

                        <!-- Simulator -->
                        <button onclick="navigateTo('sim')" class="dash-card p-4 rounded-lg border border-purple-100 bg-purple-50/50 hover:bg-purple-50 hover:shadow-md text-left group">
                             <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-graduation-cap text-2xl text-purple-600 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200">Formation</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Simulateur</h4>
                            <p class="text-xs text-slate-600 mt-1">Générateur de cas cliniques pour pratiquer.</p>
                        </button>

                         <!-- Redactor -->
                        <button onclick="navigateTo('manual')" class="dash-card p-4 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 hover:shadow-md text-left group col-span-1 sm:col-span-2 md:col-span-2">
                             <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-pen-fancy text-2xl text-slate-600 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold bg-slate-200 text-slate-700 px-2 py-0.5 rounded border border-slate-300">Outil Rédaction</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Rédacteur de Note</h4>
                            <p class="text-xs text-slate-600 mt-1">Reformulation professionnelle de tes notes narratives.</p>
                        </button>
                    </div>
                </div>

                <!-- Zone B: PTI Access -->
                <button onclick="navigateTo('app')" class="w-full bg-slate-800 text-white p-6 rounded-xl shadow-lg border border-slate-700 hover:bg-slate-700 hover:shadow-xl transition-all group flex items-center justify-between relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-teal-900/50 to-transparent pointer-events-none"></div>
                    <div class="relative z-10 text-left">
                        <h3 class="text-xl font-bold group-hover:text-teal-300 transition-colors">ACCÉDER À LA BANQUE PTI</h3>
                        <p class="text-slate-300 text-sm mt-1">Consultation des directives, création de PTI et surveillance clinique.</p>
                    </div>
                    <div class="relative z-10 bg-slate-700 p-4 rounded-full group-hover:bg-teal-600 transition-colors border border-slate-600 group-hover:border-teal-400">
                        <i class="fa-solid fa-arrow-right text-2xl"></i>
                    </div>
                </button>
                
                <p class="text-center text-[10px] text-slate-400 mt-12 font-mono">CISSS des Laurentides - Pavillon Philippe-Lapointe</p>
            </div>
        </main>

        <!-- 2. COACH VIEW -->
        <div id="view-coach" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
            <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-indigo-800">
                    <i class="fa-solid fa-user-doctor text-xl"></i>
                    <h2 class="font-bold text-lg">Assistant Clinique IA</h2>
                </div>
                <button onclick="runSimulationPTI('coach')" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors">
                     <i class="fa-solid fa-clipboard-check mr-1"></i> Convertir en PTI
                </button>
            </div>
            <div id="output-coach" class="flex-1 overflow-y-auto p-6 space-y-4 bg-white scroll-smooth">
                <div class="text-center text-slate-400 mt-20">
                    <i class="fa-solid fa-robot text-4xl mb-3 text-indigo-200"></i>
                    <p>Je suis prêt à t'assister, Dave.</p>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex gap-2">
                <input type="text" id="input-coach" class="flex-1 border border-slate-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm" placeholder="Pose ta question clinique ici..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" class="bg-indigo-600 text-white px-6 rounded-lg hover:bg-indigo-700 shadow-md font-bold"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- 3. MALAISE 6087 VIEW -->
        <div id="view-malaise" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
            <div class="bg-teal-50 p-4 border-b border-teal-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-teal-800">
                    <i class="fa-solid fa-file-medical-alt text-xl"></i>
                    <h2 class="font-bold text-lg">Évaluation Malaise (6087)</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyContent('output-malaise')" class="text-teal-600 hover:text-teal-800 text-xs font-bold uppercase"><i class="fa-regular fa-copy mr-1"></i> Copier</button>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-200">
                <p class="text-xs text-slate-500 font-bold uppercase mb-2">Entrée des observations (Vrac)</p>
                <textarea id="input-malaise" class="w-full border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-teal-500 h-24 shadow-inner" placeholder="Ex: Mme Tremblay, dif. resp, pâle, sat 88%, bruits normaux..."></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="generateMalaiseNote()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded shadow-sm text-sm transition-colors">
                        <i class="fa-solid fa-file-contract mr-2"></i>Générer Note Structurée
                    </button>
                    <button onclick="runSimulationPTI('malaise')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow-sm text-sm transition-colors">
                        <i class="fa-solid fa-clipboard-check mr-1"></i> Sim. PTI
                    </button>
                </div>
            </div>
            <div id="output-malaise" class="flex-1 overflow-y-auto p-6 bg-white prose prose-slate max-w-none text-sm leading-relaxed">
                <div class="text-center text-slate-400 mt-20">
                    <p>La note générée apparaîtra ici.</p>
                </div>
            </div>
        </div>

        <!-- 4. GUIDE VIEW -->
        <div id="view-guide" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
             <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-blue-800">
                    <i class="fa-solid fa-list-check text-xl"></i>
                    <h2 class="font-bold text-lg">Guide d'Évaluation Ciblé</h2>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-200">
                <div class="flex gap-2">
                    <input type="text" id="input-guide" class="flex-1 border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-blue-500 shadow-sm" placeholder="Quel est le problème? (ex: Douleur thoracique, Chute, Dyspnée...)" onkeypress="if(event.key==='Enter') generateGuide()">
                    <button onclick="generateGuide()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded shadow-sm text-sm">
                        <i class="fa-solid fa-search mr-2"></i>Quoi évaluer?
                    </button>
                </div>
            </div>
            <div id="output-guide" class="flex-1 overflow-y-auto p-6 bg-white prose prose-blue max-w-none text-sm leading-relaxed">
                <div class="text-center text-slate-400 mt-20">
                    <p>La checklist apparaîtra ici.</p>
                </div>
            </div>
        </div>

        <!-- 5. SIMULATOR VIEW -->
        <div id="view-sim" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
             <div class="bg-purple-50 p-4 border-b border-purple-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-purple-800">
                    <i class="fa-solid fa-graduation-cap text-xl"></i>
                    <h2 class="font-bold text-lg">Simulateur Clinique (Formation)</h2>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-200 flex gap-2 items-center">
                 <select id="input-sim" class="flex-1 border border-slate-300 rounded p-3 text-sm bg-white shadow-sm cursor-pointer">
                    <option value="cardiaque">Malaise Cardiaque</option>
                    <option value="respiratoire">Détresse Respiratoire</option>
                    <option value="neuro">AVC / Neuro</option>
                    <option value="chute">Chute avec blessure</option>
                    <option value="abdo">Douleur Abdominale</option>
                    <option value="hypoglycemie">Hypoglycémie</option>
                    <option value="delirium">Delirium / SCPD</option>
               </select>
               <button onclick="generateSimulation()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-3 rounded shadow-sm text-sm">
                   <i class="fa-solid fa-random mr-2"></i>Générer Cas
               </button>
            </div>
            <div id="output-sim" class="flex-1 overflow-y-auto p-6 bg-white prose prose-purple max-w-none text-sm leading-relaxed">
                <div class="text-center text-slate-400 mt-20">
                    <p>Le scénario de simulation apparaîtra ici.</p>
                </div>
            </div>
        </div>

        <!-- 6. MANUAL REDACTOR VIEW -->
        <div id="view-manual" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
             <div class="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                <div class="flex items-center gap-2 text-slate-700">
                    <i class="fa-solid fa-pen-fancy text-xl"></i>
                    <h2 class="font-bold text-lg">Rédacteur de Note</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyContent('output-manual')" class="text-slate-600 hover:text-slate-800 text-xs font-bold uppercase"><i class="fa-regular fa-copy mr-1"></i> Copier</button>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-200">
                <p class="text-xs text-slate-500 font-bold uppercase mb-2">Situation à reformuler</p>
                <textarea id="input-manual" class="w-full border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-slate-500 h-24 shadow-inner" placeholder="Décrivez la situation pour une note narrative standard..."></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="generateManualNote()" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 rounded shadow-sm text-sm">
                        <i class="fa-solid fa-pen-nib mr-2"></i>Rédiger Note Pro
                    </button>
                    <button onclick="runSimulationPTI('manual')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow-sm text-sm">
                        <i class="fa-solid fa-clipboard-check mr-1"></i> Sim. PTI
                    </button>
                </div>
            </div>
            <div id="output-manual" class="flex-1 overflow-y-auto p-6 bg-white prose prose-slate max-w-none text-sm leading-relaxed">
                <div class="text-center text-slate-400 mt-20">
                    <p>La note finale apparaîtra ici.</p>
                </div>
            </div>
        </div>

        <!-- 7. PTI APP VIEW (EXISTING) -->
        <div id="view-app" class="tool-view flex-row relative h-full">
            <!-- Left: Library -->
            <main class="flex-1 overflow-y-auto p-4 bg-slate-100" id="main-library">
                <div id="db-status" class="mb-4 text-xs font-bold text-slate-500 flex items-center justify-end">
                    <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-2 animate-pulse" id="status-dot"></span>
                    <span id="status-text">Initialisation...</span>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-4 sticky top-0 z-10 flex flex-wrap gap-2 items-center">
                    <span class="text-[10px] uppercase font-bold text-slate-400 mr-2"><i class="fa-solid fa-filter mr-1"></i>Catégories:</span>
                    <button class="filter-btn active bg-slate-800 text-white text-xs px-3 py-1.5 rounded font-bold transition-colors" onclick="filterLib('all', this)">Tout</button>
                    <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('scpd', this)">SCPD</button>
                    <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('soins', this)">Soins</button>
                    <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('clinique', this)">Médical</button>
                    <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('infection', this)">Infections</button>
                    <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('palliatif', this)">Palliatif</button>
                </div>
                <div id="library-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 pb-12"></div>
            </main>
            <!-- Right: Sidebar -->
            <aside id="pti-sidebar" class="fixed inset-y-0 right-0 w-full md:w-[700px] bg-white shadow-2xl z-40 transform translate-x-full transition-transform duration-300 flex flex-col border-l border-slate-200">
                <div class="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md flex-none">
                    <div>
                        <h3 class="font-bold text-sm uppercase"><i class="fa-solid fa-file-signature mr-2"></i> Prévisualisation PTI</h3>
                        <p class="text-[10px] text-slate-300">Format officiel (OIIQ/MSSS)</p>
                    </div>
                    <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 bg-white" id="pti-content">
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-300">
                        <i class="fa-solid fa-folder-plus text-6xl mb-4 text-slate-200"></i>
                        <p class="text-sm font-bold">Panier vide</p>
                        <p class="text-xs mt-1">Sélectionnez des directives dans la banque.</p>
                    </div>
                    <div id="pti-visual-table" class="hidden">
                        <div class="border-b-2 border-slate-800 mb-4 pb-2 flex justify-between items-end">
                            <h2 class="font-bold text-xl text-slate-800 tracking-tight">PLAN THÉRAPEUTIQUE</h2>
                            <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Document Légal</span>
                        </div>
                        <table class="pti-table shadow-sm">
                            <thead><tr><th style="width: 30%;">CONSTATS (PQRSTU)</th><th style="width: 70%;">DIRECTIVES INFIRMIÈRES & SURVEILLANCE</th></tr></thead>
                            <tbody id="pti-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t border-slate-200 flex-none space-y-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                    <button onclick="generatePTINote()" class="w-full bg-teal-700 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded shadow-sm text-sm flex justify-center items-center gap-2 group transition-all">
                        <i class="fa-solid fa-wand-magic-sparkles text-yellow-300 group-hover:rotate-12 transition-transform"></i> Générer Note Évolution (Basée sur PTI)
                    </button>
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="downloadDOCX()" class="bg-blue-800 hover:bg-blue-700 text-white py-3 px-4 rounded text-sm font-bold flex justify-center items-center gap-2 shadow transition-colors">
                            <i class="fa-solid fa-file-word text-white"></i> Télécharger PTI (Word/DOCX)
                        </button>
                    </div>
                </div>
            </aside>
            <button onclick="toggleSidebar()" class="absolute bottom-6 right-6 bg-slate-800 text-white p-4 rounded-full shadow-lg z-30 hover:bg-slate-700 transition-transform hover:scale-105">
                 <i class="fa-solid fa-clipboard-list text-xl"></i>
                 <span id="pti-badge-float" class="absolute top-0 right-0 bg-red-500 text-white px-2 py-0.5 rounded-full text-[10px] hidden border border-white">0</span>
            </button>
        </div>

    </div>

    <!-- Overlay -->
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative z-10">
            <h3 class="text-lg font-bold text-slate-800 mb-2"><i class="fa-solid fa-screwdriver-wrench text-teal-600 mr-2"></i>Configuration API</h3>
            <p class="text-sm text-slate-600 mb-4">Entrez votre clé API Gemini pour activer l'intelligence artificielle.</p>
            <input type="password" id="api-key-input" class="w-full border border-slate-300 rounded p-2 text-sm mb-4 focus:ring-2 focus:ring-teal-500 focus:outline-none" placeholder="Clé API (AIza...)">
            <div class="flex justify-end gap-2">
                <button onclick="closeSettings()" class="text-slate-500 hover:text-slate-700 text-sm font-bold px-4 py-2">Fermer</button>
                <button onclick="saveApiKey()" class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold px-4 py-2 rounded shadow-sm">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- LOGIQUE DE L'APPLICATION -->
    <script>
        // --- DATA FALLBACK ---
        const fallbackDatabase = [
            { id: 'scpd_resist', cat: 'scpd', title: 'Résistance aux Soins', constats: ["Ferme la bouche", "Frappe"], directives: [{ role: 'PAB', text: "Tech. du leurre." }] },
            { id: 'phy_chute', cat: 'soins', title: 'Risque de Chute', constats: ["Instable"], directives: [{ role: 'PAB', text: "Cloche à portée." }] }
        ];

        let database = []; 
        let currentPTI = {};
        
        // --- CONTEXTE FORMULAIRE 6087 (LE CERVEAU COMMUN) ---
        const context6087 = `
        RÉFÉRENCE OFFICIELLE : FORMULAIRE 6087 (Malaise Dominant)
        STRUCTURE OBLIGATOIRE :
        1. Anamnèse de départ : Journaliste/Enquêteur, PQRSTU (Provoquer, Qualité, Région, Signes, Temps, Understanding).
        2. Évolution clinique : 48h (Stable/Amél/Détérioration), 1 semaine. Perte brusque autonomie/mental/comportement.
        3. Examen Physique :
           - Inspection : Coloration (Normale, Cyanosée, Pâle, Grisâtre), État mental (Alerte, Léthargique, Stuporeux, Comateux).
           - Membres inf : Couleur, Chaleur, Mobilité, Sensibilité, Pouls, Oedème (Godet?).
        4. Signes Vitaux : Sat %, Pouls, PA, Temp (Fièvre Gériatrique >37.8 ou +1.1 base), Resp (Rythme, Amplitude, Tirage).
        5. Palpation/Auscultation : 
           - Abdomen : Bruits péristaltiques (/min), Douleur palpation (superficielle/profonde), Globe vésical, Selles.
           - Poumons : Bruits anormaux (Sibilant, Crépitant, Ronchi), Localisation.
           - Déshydratation : Langue/Aisselle humide, Pli cutané.
        6. Interventions/Info compl : Niveau soins (A,B,C,D), Changement Rx, Allergies, Labos.
        7. DANGER IMMÉDIAT / SIGNES DE DÉTRESSE : Critères majeurs pour appel MD ou Urgence.
        `;

        const envApiKey = ""; 

        document.addEventListener('DOMContentLoaded', () => {
            loadDatabase();
            const storedKey = localStorage.getItem('gemini_api_key');
            if(storedKey) document.getElementById('api-key-input').value = storedKey;
            
            // Start at Dashboard
            navigateTo('dashboard');
        });

        // --- NAVIGATION SYSTEM ---
        function navigateTo(viewName) {
            // Hide all views
            document.querySelectorAll('.tool-view').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show target view
            const target = document.getElementById('view-' + viewName);
            if(target) {
                target.classList.add('active');
                
                // Update Label in Header
                const labels = {
                    'dashboard': 'Tableau de bord',
                    'coach': 'Assistant IA',
                    'malaise': 'Malaise 6087',
                    'guide': 'Guide Ciblé',
                    'sim': 'Simulateur',
                    'manual': 'Rédacteur',
                    'app': 'Banque PTI'
                };
                document.getElementById('current-tool-label').innerText = labels[viewName] || 'Outil';
                
                // Special init for PTI App
                if(viewName === 'app') renderLibrary('all');
            }
        }

        async function loadDatabase() {
            try {
                const response = await fetch('banque_pti.xlsx');
                if (!response.ok) throw new Error("Fichier non trouvé");
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                
                const tempMap = {};
                rawData.forEach(row => {
                    if(!row['ID_UNIQUE'] || !row['DIRECTIVE']) return;
                    const id = row['ID_UNIQUE'];
                    if(!tempMap[id]) tempMap[id] = { id, cat: row['CATEGORIE'] || 'divers', title: row['TITRE'] || '?', constats: row['CONSTATS'] ? row['CONSTATS'].split(',') : [], directives: [] };
                    tempMap[id].directives.push({ role: row['ROLE'] || 'ALL', text: row['DIRECTIVE'] });
                });
                database = Object.values(tempMap);
                document.getElementById('status-text').innerText = "Base Excel chargée";
                document.getElementById('status-dot').classList.replace('bg-yellow-400', 'bg-green-500');
            } catch (error) {
                database = fallbackDatabase; 
                document.getElementById('status-text').innerText = "Mode Défaut";
                document.getElementById('status-dot').classList.replace('bg-yellow-400', 'bg-orange-500');
            }
        }

        function renderLibrary(filter, btn) {
            if(btn) { document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('bg-slate-800','text-white'); b.classList.add('bg-white','text-slate-600','border'); }); btn.classList.remove('bg-white','text-slate-600','border'); btn.classList.add('bg-slate-800','text-white'); }
            const container = document.getElementById('library-container');
            container.innerHTML = '';
            (filter === 'all' ? database : database.filter(i => i.cat === filter)).forEach(item => {
                const list = item.directives.map((d,idx) => `<li class="directive-item p-2 border-b border-slate-50 last:border-0 text-xs text-slate-600 cursor-pointer flex" onclick="addDirective('${item.title.replace(/'/g,"\\'")}', '${d.text.replace(/'/g,"\\'")}', '${d.role}')"><span class="role-badge role-${d.role.toLowerCase().replace('/','-')}">${d.role}</span>${d.text}</li>`).join('');
                container.innerHTML += `<div class="bg-white p-3 rounded shadow-sm border border-slate-200"><h3 class="font-bold text-sm text-slate-800 mb-2">${item.title}</h3><ul class="max-h-40 overflow-y-auto">${list}</ul></div>`;
            });
        }

        function addDirective(prob, text, role) {
            if (!currentPTI[prob]) currentPTI[prob] = [];
            if (!currentPTI[prob].some(d => d.text === text)) {
                currentPTI[prob].push({ text, role });
                updateSidebar();
                const b = document.getElementById('pti-badge-float'); 
                b.classList.remove('hidden'); 
                b.innerText = Object.values(currentPTI).flat().length;
            }
        }
        function updateSidebar() {
            const tbody = document.getElementById('pti-table-body');
            tbody.innerHTML = '';
            Object.keys(currentPTI).forEach(p => {
                const dirs = currentPTI[p].map((d,i) => `<div class="flex justify-between border-b border-dashed border-slate-100 p-1 text-xs"><span><b class="text-[9px] mr-1">[${d.role}]</b>${d.text}</span><i class="fa-solid fa-trash text-slate-300 hover:text-red-500 cursor-pointer" onclick="removeDirective('${p}',${i})"></i></div>`).join('');
                tbody.innerHTML += `<tr><td class="font-bold text-xs bg-slate-50">${p}</td><td>${dirs}</td></tr>`;
            });
            document.getElementById('pti-visual-table').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }
        function removeDirective(p,i) { currentPTI[p].splice(i,1); if(currentPTI[p].length===0) delete currentPTI[p]; updateSidebar(); }

        // --- UI UTILS ---
        function toggleSidebar() { document.getElementById('pti-sidebar').classList.toggle('translate-x-full'); document.getElementById('overlay').classList.toggle('hidden'); }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); }
        function saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value); closeSettings(); }
        function copyContent(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text);
            alert("Contenu copié !");
        }

        // --- CORE AI LOGIC (CENTRALISÉE) ---
        async function callGemini(prompt, sysContext) {
            const apiKey = localStorage.getItem('gemini_api_key') || envApiKey;
            if (!apiKey) { openSettings(); return "⚠️ Clé API manquante. Configurez-la via la roue dentée."; }

            // INSTRUCTIONS DE SÉCURITÉ & PERSONNALITÉ (Dave's preferences)
            const securityInstruction = `
            CRITIQUE : ANALYSE DE SÉCURITÉ CONSTANTE (FORM 6087)
            Si tu détectes des mots-clés de "Danger immédiat" ou "Signes de détresse" (ex: Teint grisâtre, léthargie, sat < 85%, détresse resp, changement brusque comportement), tu DOIS commencer ta réponse par un bloc d'alerte :
            <div class="bg-red-50 border-l-4 border-red-500 p-2 mb-4 text-red-700 font-bold text-xs"><i class="fa-solid fa-triangle-exclamation mr-1"></i> ALERTE CLINIQUE 6087: Critères de détresse détectés. Vérifier le niveau de soins.</div>
            
            TON : Tu parles avec un accent québécois professionnel et neutre. Tu t'adresses à un collègue infirmier (Dave).
            `;

            const fullSystem = `${sysContext}\n\n${context6087}\n\n${securityInstruction}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: fullSystem }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur API.";
            } catch (e) { return "Erreur connexion."; }
        }

        function showLoading(outputId) {
            const out = document.getElementById(outputId);
            const loader = document.createElement('div');
            loader.className = "mb-3 loading-indicator flex justify-center py-4";
            loader.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            out.appendChild(loader);
            out.scrollTop = out.scrollHeight;
        }
        function hideLoading() { document.querySelectorAll('.loading-indicator').forEach(e => e.remove()); }

        // --- FEATURE 1: COACH CHAT ---
        async function sendChat() {
            const input = document.getElementById('input-coach');
            const q = input.value; 
            if(!q) return;
            
            const out = document.getElementById('output-coach');
            out.innerHTML += `<div class="mb-4 text-right"><span class="bg-indigo-100 text-indigo-800 py-2 px-3 rounded-lg inline-block text-sm shadow-sm border border-indigo-200 font-medium">${q}</span></div>`;
            input.value = "";
            showLoading('output-coach');

            const sys = "Tu es un expert clinique 'Coach' pour infirmières en CHSLD. Réponds de façon pédagogique.";
            const res = await callGemini(q, sys);
            
            hideLoading();
            out.innerHTML += `<div class="mb-6 text-slate-700 bg-white p-0 rounded-lg prose prose-sm max-w-none border-l-4 border-indigo-500 pl-4"><div class="flex gap-3"><div>${marked.parse(res)}</div></div></div>`;
            out.scrollTop = out.scrollHeight;
        }

        // --- FEATURE 2: MALAISE 6087 GENERATOR ---
        async function generateMalaiseNote() {
            const text = document.getElementById('input-malaise').value;
            if(!text) return;
            document.getElementById('output-malaise').innerHTML = "";
            showLoading('output-malaise');

            const prompt = `Voici des observations en vrac : "${text}". \n\nGénère une note structurée EXCLUSIVEMENT selon les titres du formulaire 6087. Si une info est manquante, laisse la section vide ou mets 'Non mentionné'. Sois précis et concis.`;
            const sys = "Tu es un assistant de documentation clinique expert du formulaire 6087. Tu ne fais que reformater les données.";
            
            const res = await callGemini(prompt, sys);
            hideLoading();
            document.getElementById('output-malaise').innerHTML = `<div class="bg-slate-50 border border-slate-200 rounded p-6 shadow-inner">${marked.parse(res)}</div>`;
        }

        // --- FEATURE 3: TARGETED GUIDE ---
        async function generateGuide() {
            const problem = document.getElementById('input-guide').value;
            if(!problem) return;
            document.getElementById('output-guide').innerHTML = "";
            showLoading('output-guide');

            const prompt = `Le résident présente : ${problem}. \n\nAgis comme un guide interactif. Liste les éléments SPÉCIFIQUES du formulaire 6087 à vérifier pour CE problème précis (ex: quel type de palpation, quels signes vitaux surveiller, quels signes de détresse chercher). Fais une checklist.`;
            const sys = "Tu es un mentor clinique. Tu aides à ne rien oublier lors de l'évaluation d'un malaise dominant.";

            const res = await callGemini(prompt, sys);
            hideLoading();
            document.getElementById('output-guide').innerHTML = `<div class="bg-blue-50 border border-blue-100 rounded p-4 shadow-sm">${marked.parse(res)}</div>`;
        }

        // --- FEATURE 4: SIMULATOR ---
        async function generateSimulation() {
            const type = document.getElementById('input-sim').value;
            document.getElementById('output-sim').innerHTML = "";
            showLoading('output-sim');

            const prompt = `Génère un scénario clinique fictif complet pour un cas de : ${type}. \n\nPrésente le cas COMME SI on lisait un formulaire 6087 rempli (Anamnèse, PQRSTU, Vitaux, Examen physique détaillé). C'est pour la formation d'une infirmière.`;
            const sys = "Tu es un générateur de simulation clinique pour la formation.";

            const res = await callGemini(prompt, sys);
            hideLoading();
            document.getElementById('output-sim').innerHTML = `<div class="bg-purple-50 border border-purple-100 rounded p-6 shadow-sm relative"><span class="absolute top-2 right-2 text-xs font-bold text-purple-300 uppercase">Simulation</span>${marked.parse(res)}</div>`;
        }

        // --- FEATURE 5: TRIAGE AUTO (SIMULATION PTI) ---
        async function runSimulationPTI(sourceView) {
            let context = "";
            let outputId = "";

            if(sourceView === 'coach') {
                context = document.getElementById('output-coach').innerText;
                outputId = 'output-coach';
            } else if (sourceView === 'malaise') {
                context = document.getElementById('input-malaise').value;
                outputId = 'output-malaise';
            } else if (sourceView === 'manual') {
                context = document.getElementById('input-manual').value;
                outputId = 'output-manual';
            }

            if(!context || context.length < 10) return alert("Pas assez d'information pour simuler un PTI.");
            
            showLoading(outputId);

            const prompt = `Basé sur ces données cliniques :\n"${context.substring(0, 1500)}..."\n\nAgis comme le 'Triage Automatique'. Suggère un PTI (Problème/Besoin prioritaire + Directives infirmières concrètes). Utilise le format : PROBLÈME : ... / DIRECTIVES : ...`;
            const sys = "Tu es un expert en élaboration de PTI (Plan Thérapeutique Infirmier). Tu analyses les données pour trouver les problèmes prioritaires.";

            const res = await callGemini(prompt, sys);
            hideLoading();
            
            const currentOut = document.getElementById(outputId);
            const ptiBlock = `<div class="mt-4 border-t-2 border-indigo-100 pt-4"><div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg shadow-sm"><h4 class="font-bold text-indigo-800 text-xs uppercase mb-2"><i class="fa-solid fa-clipboard-list mr-2"></i>Suggestion PTI Automatique</h4><div class="prose prose-sm text-indigo-900">${marked.parse(res)}</div></div></div>`;
            
            // Append or replace depending on view type (Coach appends, others might just show below)
            currentOut.innerHTML += ptiBlock;
            currentOut.scrollTop = currentOut.scrollHeight;
        }

        // --- MANUAL NOTE ---
        async function generateManualNote() {
            const text = document.getElementById('input-manual').value;
            if(!text) return;
            document.getElementById('output-manual').innerHTML = "";
            showLoading('output-manual');
            const res = await callGemini(`Rédige une note concise pour: "${text}"`, "Tu es experte en documentation.");
            hideLoading();
            document.getElementById('output-manual').innerHTML = `<div class="bg-white border border-slate-200 p-4 rounded shadow-sm">${marked.parse(res)}</div>`;
        }

        // --- WORD DOWNLOAD ---
        function downloadDOCX() {
            const problems = Object.keys(currentPTI);
            if (problems.length === 0) return alert("Le panier PTI est vide.");

            const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, TextRun, HeadingLevel, AlignmentType, BorderStyle } = docx;

            const rows = [
                new TableRow({
                    children: [
                        new TableCell({ children: [new Paragraph({ text: "CONSTATS (PQRSTU)", active: true, bold: true })], width: { size: 35, type: WidthType.PERCENTAGE }, shading: { fill: "f3f4f6" } }),
                        new TableCell({ children: [new Paragraph({ text: "DIRECTIVES & SURVEILLANCE", active: true, bold: true })], width: { size: 65, type: WidthType.PERCENTAGE }, shading: { fill: "f3f4f6" } }),
                    ],
                }),
            ];

            for (const prob of problems) {
                const directives = currentPTI[prob];
                const dirParagraphs = directives.map(d => 
                    new Paragraph({ children: [ new TextRun({ text: d.text + " ", size: 22 }), new TextRun({ text: `[${d.role}]`, bold: true, size: 18, color: "666666" }) ], bullet: { level: 0 } })
                );
                rows.push(new TableRow({ children: [ new TableCell({ children: [new Paragraph({ text: prob, bold: true })], width: { size: 35, type: WidthType.PERCENTAGE } }), new TableCell({ children: dirParagraphs, width: { size: 65, type: WidthType.PERCENTAGE } }) ] }));
            }

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "PLAN THÉRAPEUTIQUE INFIRMIER (PTI)", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 100 } }),
                        new Paragraph({ text: "CISSS des Laurentides - Pavillon Philippe-Lapointe", alignment: AlignmentType.CENTER, spacing: { after: 400 } }),
                        new Table({ rows: rows, width: { size: 100, type: WidthType.PERCENTAGE } }),
                        new Paragraph({ children: [ new TextRun({ text: "\n\nSignature infirmière: __________________________________________________  Permis: ______________", bold: true }) ], spacing: { before: 800 } })
                    ],
                }],
            });

            Packer.toBlob(doc).then(blob => { saveAs(blob, "PTI_Expert_Document.docx"); }).catch(err => { console.error(err); alert("Erreur Word."); });
        }

        // --- NEW: GENERATE PTI NOTE (FROM BASKET) ---
        async function generatePTINote() {
            const problems = Object.keys(currentPTI);
            if(problems.length === 0) return alert("Veuillez d'abord ajouter des éléments au PTI.");

            // Switch to a 'result' view or use a modal? Let's use the Coach view for the result
            navigateTo('coach');
            
            let context = "";
            problems.forEach(p => {
                context += `PROBLÈME: ${p}\n`;
                currentPTI[p].forEach(d => context += `- ${d.text}\n`);
            });

            const out = document.getElementById('output-coach');
            out.innerHTML += `<div class="mb-4 text-center text-xs text-slate-400 font-bold uppercase">--- GÉNÉRATION NOTE ÉVOLUTION ---</div>`;
            showLoading('output-coach');

            const prompt = `Voici les constats et interventions PTI :\n${context}\n\nRédige une note d'évolution narrative TRÈS CONCISE (style télégraphique amélioré).`;
            const sys = "Tu es une infirmière expérimentée en CHSLD au Québec.";
            
            const res = await callGemini(prompt, sys);
            hideLoading();
            out.innerHTML += `<div class="mb-6 bg-teal-50 text-slate-700 p-4 rounded-lg prose prose-sm max-w-none border border-teal-200 shadow-sm">${marked.parse(res)}</div>`;
            out.scrollTop = out.scrollHeight;
        }

    </script>
</body>
</html>