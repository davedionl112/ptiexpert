<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTI EXPERT - Suite Clinique 6087</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- SheetJS (Pour Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- DOCX & FileSaver (Pour générer le Word) -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; }
        h1, h2, h3 { font-family: 'Roboto', sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        /* Card Hover */
        .directive-item:hover { background-color: #f0f9ff; border-left: 3px solid #0ea5e9; }
        .directive-item { transition: all 0.1s ease; border-left: 3px solid transparent; }
        
        /* PTI Table Styling */
        .pti-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 10px; }
        .pti-table th { background-color: #e2e8f0; padding: 10px; text-align: left; font-weight: bold; border: 2px solid #94a3b8; text-transform: uppercase; }
        .pti-table td { padding: 10px; border: 1px solid #cbd5e1; vertical-align: top; }
        
        .role-badge {
            font-size: 0.60rem; padding: 2px 5px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-right: 6px; display: inline-block; min-width: 35px; text-align: center;
        }
        /* Role Colors */
        .role-pab { background-color: #dbeafe; color: #1e3a8a; border: 1px solid #93c5fd; } /* Blue */
        .role-aux { background-color: #fce7f3; color: #831843; border: 1px solid #f9a8d4; } /* Pink */
        .role-inf { background-color: #dcfce7; color: #14532d; border: 1px solid #86efac; } /* Green */
        .role-all { background-color: #f1f5f9; color: #334151; border: 1px solid #cbd5e1; } /* Grey */
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            width: 6px; height: 6px; background-color: #475569; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Tabs Styling */
        .active-tab { border-bottom: 3px solid #0d9488; color: #0f766e; font-weight: 700; background: #f0fdfa; }
        .inactive-tab { color: #64748b; background: #f8fafc; border-bottom: 3px solid transparent; }
        .inactive-tab:hover { background: #f1f5f9; color: #475569; }
        
        /* Modal Settings Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.3s, transform 0.3s; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-slate-50">

    <!-- Header -->
    <header class="bg-slate-800 text-white h-14 flex items-center justify-between px-4 shadow-lg z-20 flex-none">
        <div class="flex items-center gap-3">
            <div class="bg-teal-600 p-1.5 rounded"><i class="fa-solid fa-user-nurse text-white text-lg"></i></div>
            <div>
                <h1 class="text-base font-bold leading-tight">PTI EXPERT <span class="text-teal-400">CLINIQUE</span></h1>
                <p class="text-[10px] text-slate-400">Assistant & Formulaire 6087 <span class="text-red-400 font-bold ml-1">(v4.0)</span></p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openSettings()" class="flex items-center gap-2 text-xs bg-slate-700 hover:bg-slate-600 text-yellow-400 hover:text-white px-3 py-2 rounded transition-colors border border-slate-600" title="Paramètres API">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button onclick="openAIModal('coach')" class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded font-bold transition-colors flex items-center gap-2 border border-indigo-400 shadow-sm animate-[pulse_3s_infinite]">
                <i class="fa-solid fa-robot"></i> Assistant IA
            </button>
            <button onclick="toggleSidebar()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded font-bold transition-colors flex items-center gap-2 border border-slate-500 shadow-sm relative">
                <i class="fa-solid fa-clipboard-list"></i>
                <span class="hidden sm:inline">Panier PTI</span>
                <span id="pti-badge" class="absolute -top-1 -right-1 bg-red-500 text-white px-1.5 h-4 flex items-center justify-center rounded-full text-[9px] hidden shadow-sm border border-white">0</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Left: Library (Scrollable) -->
        <main class="flex-1 overflow-y-auto p-4 bg-slate-100" id="main-library">
            
            <!-- Excel Loader Status -->
            <div id="db-status" class="mb-4 text-xs font-bold text-slate-500 flex items-center justify-end">
                <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-2 animate-pulse" id="status-dot"></span>
                <span id="status-text">Initialisation...</span>
            </div>

            <!-- Filters -->
            <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-4 sticky top-0 z-10 flex flex-wrap gap-2 items-center">
                <span class="text-[10px] uppercase font-bold text-slate-400 mr-2"><i class="fa-solid fa-filter mr-1"></i>Catégories:</span>
                <button class="filter-btn active bg-slate-800 text-white text-xs px-3 py-1.5 rounded font-bold transition-colors" onclick="filterLib('all', this)">Tout</button>
                <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('scpd', this)">SCPD</button>
                <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('soins', this)">Soins</button>
                <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('clinique', this)">Médical</button>
                <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('infection', this)">Infections</button>
                <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="filterLib('palliatif', this)">Palliatif</button>
            </div>

            <!-- Library Grid -->
            <div id="library-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 pb-12">
                <!-- Cards injected via JS -->
            </div>
        </main>

        <!-- Right: PTI Sidebar (Overlay/Slide-in) -->
        <aside id="pti-sidebar" class="fixed inset-y-0 right-0 w-full md:w-[700px] bg-white shadow-2xl z-40 transform translate-x-full transition-transform duration-300 flex flex-col border-l border-slate-200">
            <!-- Sidebar Header -->
            <div class="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md flex-none">
                <div>
                    <h3 class="font-bold text-sm uppercase"><i class="fa-solid fa-file-signature mr-2"></i> Prévisualisation PTI</h3>
                    <p class="text-[10px] text-slate-300">Format officiel (OIIQ/MSSS)</p>
                </div>
                <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <!-- PTI Content (Scrollable) -->
            <div class="flex-1 overflow-y-auto p-6 bg-white" id="pti-content">
                <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-300">
                    <i class="fa-solid fa-folder-plus text-6xl mb-4 text-slate-200"></i>
                    <p class="text-sm font-bold">Panier vide</p>
                    <p class="text-xs mt-1">Sélectionnez des directives dans la banque.</p>
                </div>
                
                <!-- The Visual PTI Table -->
                <div id="pti-visual-table" class="hidden">
                    <div class="border-b-2 border-slate-800 mb-4 pb-2 flex justify-between items-end">
                        <h2 class="font-bold text-xl text-slate-800 tracking-tight">PLAN THÉRAPEUTIQUE</h2>
                        <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Document Légal</span>
                    </div>
                    <table class="pti-table shadow-sm">
                        <thead>
                            <tr>
                                <th style="width: 30%;">CONSTATS (PQRSTU)</th>
                                <th style="width: 70%;">DIRECTIVES INFIRMIÈRES & SURVEILLANCE</th>
                            </tr>
                        </thead>
                        <tbody id="pti-table-body">
                            <!-- Rows generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Footer -->
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex-none space-y-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <button onclick="generatePTINote()" class="w-full bg-teal-700 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded shadow-sm text-sm flex justify-center items-center gap-2 group transition-all">
                    <i class="fa-solid fa-wand-magic-sparkles text-yellow-300 group-hover:rotate-12 transition-transform"></i> 
                    Générer Note Évolution (Basée sur PTI)
                </button>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="downloadDOCX()" class="bg-blue-800 hover:bg-blue-700 text-white py-3 px-4 rounded text-sm font-bold flex justify-center items-center gap-2 shadow transition-colors">
                        <i class="fa-solid fa-file-word text-white"></i> Télécharger PTI (Word/DOCX)
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Overlay -->
    <div id="overlay" onclick="closeAllModals()" class="fixed inset-0 bg-black/50 z-30 hidden backdrop-blur-sm transition-opacity"></div>

    <!-- AI Modal (Super-App Wrapper) -->
    <div id="ai-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeAIModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col relative z-10 overflow-hidden transform transition-all">
            
            <!-- Modal Tabs (Navigation) -->
            <div class="flex border-b border-slate-200 bg-slate-50 overflow-x-auto no-scrollbar flex-none">
                <button id="tab-coach" class="px-4 py-3 text-sm transition-colors active-tab whitespace-nowrap flex-1 md:flex-none" onclick="switchTab('coach')">
                    <i class="fa-solid fa-user-doctor mr-2"></i>Coach Clinique
                </button>
                <button id="tab-malaise" class="px-4 py-3 text-sm transition-colors inactive-tab whitespace-nowrap flex-1 md:flex-none" onclick="switchTab('malaise')">
                    <i class="fa-solid fa-file-medical-alt mr-2"></i>Éval. Malaise 6087
                </button>
                <button id="tab-guide" class="px-4 py-3 text-sm transition-colors inactive-tab whitespace-nowrap flex-1 md:flex-none" onclick="switchTab('guide')">
                    <i class="fa-solid fa-list-check mr-2"></i>Guide Ciblé
                </button>
                <button id="tab-sim" class="px-4 py-3 text-sm transition-colors inactive-tab whitespace-nowrap flex-1 md:flex-none" onclick="switchTab('sim')">
                    <i class="fa-solid fa-graduation-cap mr-2"></i>Simulateur
                </button>
                <button id="tab-manual" class="px-4 py-3 text-sm transition-colors inactive-tab whitespace-nowrap flex-1 md:flex-none" onclick="switchTab('manual')">
                    <i class="fa-solid fa-pen-fancy mr-2"></i>Rédacteur
                </button>
                <button onclick="closeAIModal()" class="ml-auto px-5 text-slate-400 hover:text-slate-600 border-l border-slate-200 hover:bg-slate-100 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <!-- MAIN CONTENT AREA -->
            <div class="flex-1 flex flex-col overflow-hidden bg-white relative">
                
                <!-- INPUT AREAS (DYNAMIC) -->
                
                <!-- 1. COACH INPUT (Only for coach tab) -->
                <div id="coach-input-section" class="hidden absolute bottom-0 left-0 right-0 p-4 border-t border-slate-200 bg-slate-50 z-20">
                    <div class="flex gap-2">
                        <button onclick="runSimulationPTI('chat')" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg shadow-sm text-xs font-bold whitespace-nowrap" title="Analyser la conversation pour PTI">
                            <i class="fa-solid fa-clipboard-check mr-1"></i> SIMULATION PTI
                        </button>
                        <input type="text" id="ai-input" class="flex-1 border border-slate-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm" placeholder="Question clinique ou situation...">
                        <button onclick="sendChat()" class="bg-indigo-600 text-white px-5 rounded-lg hover:bg-indigo-700 shadow-md"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>

                <!-- 2. MALAISE 6087 INPUT -->
                <div id="malaise-input-section" class="hidden p-4 bg-slate-50 border-b border-slate-200 flex-none">
                    <div class="flex flex-col gap-2">
                        <p class="text-xs text-slate-500 font-bold uppercase"><i class="fa-solid fa-notes-medical mr-1"></i> Générateur de Note Structurée (6087)</p>
                        <textarea id="malaise-text" class="w-full border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-teal-500 mb-2 h-20" placeholder="Entrez vos observations en vrac (ex: Mme Tremblay, dif. resp, pâle, sat 88%, bruits normaux...)"></textarea>
                        <div class="flex gap-2">
                            <button onclick="generateMalaiseNote()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded shadow-sm text-sm">
                                <i class="fa-solid fa-file-contract mr-2"></i>Générer Note 6087
                            </button>
                            <button onclick="runSimulationPTI('malaise')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow-sm text-sm">
                                <i class="fa-solid fa-clipboard-check mr-1"></i> Sim. PTI
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. GUIDE CIBLÉ INPUT -->
                <div id="guide-input-section" class="hidden p-4 bg-slate-50 border-b border-slate-200 flex-none">
                     <p class="text-xs text-slate-500 font-bold uppercase mb-2"><i class="fa-solid fa-bullseye mr-1"></i> Aide-mémoire interactif</p>
                    <div class="flex gap-2">
                        <input type="text" id="guide-input" class="flex-1 border border-slate-300 rounded p-2 text-sm" placeholder="Quel est le problème? (ex: Douleur abdominale, Chute, Dyspnée...)">
                        <button onclick="generateGuide()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded shadow-sm text-sm">
                            <i class="fa-solid fa-search mr-2"></i>Quoi évaluer?
                        </button>
                    </div>
                </div>

                <!-- 4. SIMULATOR INPUT -->
                <div id="sim-input-section" class="hidden p-4 bg-slate-50 border-b border-slate-200 flex-none">
                    <p class="text-xs text-slate-500 font-bold uppercase mb-2"><i class="fa-solid fa-chalkboard-user mr-1"></i> Formation Continue</p>
                   <div class="flex gap-2 items-center">
                       <select id="sim-type" class="border border-slate-300 rounded p-2 text-sm bg-white">
                           <option value="cardiaque">Malaise Cardiaque</option>
                           <option value="respiratoire">Détresse Respiratoire</option>
                           <option value="neuro">AVC / Neuro</option>
                           <option value="chute">Chute avec blessure</option>
                           <option value="abdo">Douleur Abdominale</option>
                           <option value="hypoglycemie">Hypoglycémie</option>
                           <option value="delirium">Delirium / SCPD</option>
                       </select>
                       <button onclick="generateSimulation()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded shadow-sm text-sm flex-1">
                           <i class="fa-solid fa-random mr-2"></i>Générer un cas clinique (6087)
                       </button>
                   </div>
               </div>

                <!-- 5. MANUAL INPUT -->
                <div id="manual-input-section" class="hidden p-4 bg-slate-50 border-b border-slate-200 flex-none">
                    <textarea id="manual-text" class="w-full border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-teal-500 mb-2" rows="3" placeholder="Décrivez la situation pour une note narrative standard..."></textarea>
                    <div class="flex gap-2">
                        <button onclick="generateManualNote()" class="flex-1 bg-teal-600 text-white font-bold py-2 rounded shadow-sm hover:bg-teal-700">
                            <i class="fa-solid fa-pen-nib mr-2"></i>Rédiger Note
                        </button>
                         <button onclick="runSimulationPTI('manual')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow-sm text-sm">
                                <i class="fa-solid fa-clipboard-check mr-1"></i> Sim. PTI
                        </button>
                    </div>
                </div>

                <!-- OUTPUT DISPLAY (SHARED) -->
                <div id="ai-output" class="flex-1 overflow-y-auto p-6 text-sm text-slate-800 leading-relaxed bg-white font-medium pb-20 scroll-smooth">
                    <!-- Dynamic content lands here -->
                </div>

                <!-- FOOTER ACTIONS -->
                <div id="ai-footer" class="hidden absolute bottom-0 right-0 p-4 flex gap-2 z-20">
                    <button onclick="copyNote()" class="bg-slate-700 text-white px-4 py-2 rounded shadow hover:bg-slate-800 text-xs font-bold uppercase transition-colors">
                        <i class="fa-regular fa-copy mr-1"></i> Copier
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative z-10">
            <h3 class="text-lg font-bold text-slate-800 mb-2"><i class="fa-solid fa-screwdriver-wrench text-teal-600 mr-2"></i>Configuration API</h3>
            <p class="text-sm text-slate-600 mb-4">
                Entrez votre clé API Gemini pour activer l'intelligence artificielle.
            </p>
            <input type="password" id="api-key-input" class="w-full border border-slate-300 rounded p-2 text-sm mb-4 focus:ring-2 focus:ring-teal-500 focus:outline-none" placeholder="Clé API (AIza...)">
            <div class="flex justify-end gap-2">
                <button onclick="closeSettings()" class="text-slate-500 hover:text-slate-700 text-sm font-bold px-4 py-2">Fermer</button>
                <button onclick="saveApiKey()" class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold px-4 py-2 rounded shadow-sm">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- LOGIQUE DE L'APPLICATION -->
    <script>
        // --- DATA FALLBACK ---
        const fallbackDatabase = [
            { id: 'scpd_resist', cat: 'scpd', title: 'Résistance aux Soins', constats: ["Ferme la bouche", "Frappe"], directives: [{ role: 'PAB', text: "Tech. du leurre." }] },
            { id: 'phy_chute', cat: 'soins', title: 'Risque de Chute', constats: ["Instable"], directives: [{ role: 'PAB', text: "Cloche à portée." }] }
        ];

        let database = []; 
        let currentPTI = {};
        let currentTab = 'coach';
        
        // --- CONTEXTE FORMULAIRE 6087 (LE CERVEAU) ---
        // Cette constante nourrit l'IA avec la structure exacte du PDF fourni.
        const context6087 = `
        RÉFÉRENCE OFFICIELLE : FORMULAIRE 6087 (Malaise Dominant)
        STRUCTURE OBLIGATOIRE :
        1. Anamnèse de départ : Journaliste/Enquêteur, PQRSTU (Provoquer, Qualité, Région, Signes, Temps, Understanding).
        2. Évolution clinique : 48h (Stable/Amél/Détérioration), 1 semaine. Perte brusque autonomie/mental/comportement.
        3. Examen Physique :
           - Inspection : Coloration (Normale, Cyanosée, Pâle, Grisâtre), État mental (Alerte, Léthargique, Stuporeux, Comateux).
           - Membres inf : Couleur, Chaleur, Mobilité, Sensibilité, Pouls, Oedème (Godet?).
        4. Signes Vitaux : Sat %, Pouls, PA, Temp (Fièvre Gériatrique >37.8 ou +1.1 base), Resp (Rythme, Amplitude, Tirage).
        5. Palpation/Auscultation : 
           - Abdomen : Bruits péristaltiques (/min), Douleur palpation (superficielle/profonde), Globe vésical, Selles.
           - Poumons : Bruits anormaux (Sibilant, Crépitant, Ronchi), Localisation.
           - Déshydratation : Langue/Aisselle humide, Pli cutané.
        6. Interventions/Info compl : Niveau soins (A,B,C,D), Changement Rx, Allergies, Labos.
        7. DANGER IMMÉDIAT / SIGNES DE DÉTRESSE : Critères majeurs pour appel MD ou Urgence.
        `;

        const envApiKey = ""; 

        document.addEventListener('DOMContentLoaded', () => {
            loadDatabase();
            const storedKey = localStorage.getItem('gemini_api_key');
            if(storedKey) document.getElementById('api-key-input').value = storedKey;
        });

        async function loadDatabase() {
            try {
                const response = await fetch('banque_pti.xlsx');
                if (!response.ok) throw new Error("Fichier non trouvé");
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                
                const tempMap = {};
                rawData.forEach(row => {
                    if(!row['ID_UNIQUE'] || !row['DIRECTIVE']) return;
                    const id = row['ID_UNIQUE'];
                    if(!tempMap[id]) tempMap[id] = { id, cat: row['CATEGORIE'] || 'divers', title: row['TITRE'] || '?', constats: row['CONSTATS'] ? row['CONSTATS'].split(',') : [], directives: [] };
                    tempMap[id].directives.push({ role: row['ROLE'] || 'ALL', text: row['DIRECTIVE'] });
                });
                database = Object.values(tempMap);
                document.getElementById('status-text').innerText = "Base Excel chargée";
                document.getElementById('status-dot').classList.replace('bg-yellow-400', 'bg-green-500');
                renderLibrary('all');
            } catch (error) {
                database = fallbackDatabase; 
                document.getElementById('status-text').innerText = "Mode Défaut";
                document.getElementById('status-dot').classList.replace('bg-yellow-400', 'bg-orange-500');
                renderLibrary('all');
            }
        }

        function renderLibrary(filter, btn) {
            if(btn) { document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('bg-slate-800','text-white'); b.classList.add('bg-white','text-slate-600','border'); }); btn.classList.remove('bg-white','text-slate-600','border'); btn.classList.add('bg-slate-800','text-white'); }
            const container = document.getElementById('library-container');
            container.innerHTML = '';
            (filter === 'all' ? database : database.filter(i => i.cat === filter)).forEach(item => {
                const list = item.directives.map((d,idx) => `<li class="directive-item p-2 border-b border-slate-50 last:border-0 text-xs text-slate-600 cursor-pointer flex" onclick="addDirective('${item.title.replace(/'/g,"\\'")}', '${d.text.replace(/'/g,"\\'")}', '${d.role}')"><span class="role-badge role-${d.role.toLowerCase().replace('/','-')}">${d.role}</span>${d.text}</li>`).join('');
                container.innerHTML += `<div class="bg-white p-3 rounded shadow-sm border border-slate-200"><h3 class="font-bold text-sm text-slate-800 mb-2">${item.title}</h3><ul class="max-h-40 overflow-y-auto">${list}</ul></div>`;
            });
        }

        function addDirective(prob, text, role) {
            if (!currentPTI[prob]) currentPTI[prob] = [];
            if (!currentPTI[prob].some(d => d.text === text)) {
                currentPTI[prob].push({ text, role });
                updateSidebar();
                const b = document.getElementById('pti-badge'); b.classList.remove('hidden'); b.innerText = Object.values(currentPTI).flat().length;
            }
        }
        function updateSidebar() {
            const tbody = document.getElementById('pti-table-body');
            tbody.innerHTML = '';
            Object.keys(currentPTI).forEach(p => {
                const dirs = currentPTI[p].map((d,i) => `<div class="flex justify-between border-b border-dashed border-slate-100 p-1 text-xs"><span><b class="text-[9px] mr-1">[${d.role}]</b>${d.text}</span><i class="fa-solid fa-trash text-slate-300 hover:text-red-500 cursor-pointer" onclick="removeDirective('${p}',${i})"></i></div>`).join('');
                tbody.innerHTML += `<tr><td class="font-bold text-xs bg-slate-50">${p}</td><td>${dirs}</td></tr>`;
            });
            document.getElementById('pti-visual-table').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }
        function removeDirective(p,i) { currentPTI[p].splice(i,1); if(currentPTI[p].length===0) delete currentPTI[p]; updateSidebar(); }

        // --- UI NAVIGATION ---
        function toggleSidebar() { document.getElementById('pti-sidebar').classList.toggle('translate-x-full'); document.getElementById('overlay').classList.toggle('hidden'); }
        function openAIModal(tab) { document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-modal').classList.add('flex'); if(tab) switchTab(tab); }
        function closeAIModal() { document.getElementById('ai-modal').classList.add('hidden'); document.getElementById('ai-modal').classList.remove('flex'); }
        function closeAllModals() { toggleSidebar(); closeAIModal(); closeSettings(); }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); }
        function saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value); closeSettings(); }

        function switchTab(mode) {
            currentTab = mode;
            // Tabs styles
            ['coach','malaise','guide','sim','manual'].forEach(t => {
                const el = document.getElementById('tab-'+t);
                el.className = (t === mode) ? "px-4 py-3 text-sm transition-colors active-tab whitespace-nowrap flex-1 md:flex-none" : "px-4 py-3 text-sm transition-colors inactive-tab whitespace-nowrap flex-1 md:flex-none";
            });

            // Input sections
            ['coach','malaise','guide','sim','manual'].forEach(t => {
                document.getElementById(t+'-input-section').classList.add('hidden');
            });
            document.getElementById(mode+'-input-section').classList.remove('hidden');
            
            // Footer logic
            const footer = document.getElementById('ai-footer');
            if (mode === 'coach') footer.classList.add('hidden');
            else footer.classList.remove('hidden');

            // Default Output
            const out = document.getElementById('ai-output');
            if(out.innerHTML.trim() === "") {
                if(mode === 'coach') out.innerHTML = '<div class="text-center text-slate-400 mt-20"><i class="fa-solid fa-robot text-4xl mb-3 text-indigo-200"></i><p>Je suis prêt à t\'assister.</p></div>';
                if(mode === 'malaise') out.innerHTML = '<div class="text-center text-slate-400 mt-20"><i class="fa-solid fa-file-medical text-4xl mb-3 text-teal-200"></i><p>Entre tes observations pour générer une note structurée 6087.</p></div>';
            }
        }

        // --- CORE AI LOGIC ---
        async function callGemini(prompt, sysContext) {
            const apiKey = localStorage.getItem('gemini_api_key') || envApiKey;
            if (!apiKey) { openSettings(); return "⚠️ Clé API manquante. Configurez-la via la roue dentée."; }

            // INTEGRATION IDÉE 3 : RED FLAGS (Analyseur Sécurité)
            const securityInstruction = `
            CRITIQUE : ANALYSE DE SÉCURITÉ CONSTANTE (FORM 6087)
            Si tu détectes des mots-clés de "Danger immédiat" ou "Signes de détresse" (ex: Teint grisâtre, léthargie, sat < 85%, détresse resp, changement brusque comportement), tu DOIS commencer ta réponse par un bloc d'alerte :
            <div class="bg-red-50 border-l-4 border-red-500 p-2 mb-4 text-red-700 font-bold text-xs"><i class="fa-solid fa-triangle-exclamation mr-1"></i> ALERTE CLINIQUE 6087: Critères de détresse détectés. Vérifier le niveau de soins.</div>
            `;

            const fullSystem = `${sysContext}\n\n${context6087}\n\n${securityInstruction}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: fullSystem }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur API.";
            } catch (e) { return "Erreur connexion."; }
        }

        function showLoading() {
            const out = document.getElementById('ai-output');
            out.innerHTML += `<div class="mb-3 loading-indicator flex justify-center"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
            out.scrollTop = out.scrollHeight;
        }
        function hideLoading() { document.querySelectorAll('.loading-indicator').forEach(e => e.remove()); }

        // --- FEATURE 1: COACH CHAT ---
        async function sendChat() {
            const input = document.getElementById('ai-input');
            const q = input.value; 
            if(!q) return;
            
            const out = document.getElementById('ai-output');
            out.innerHTML += `<div class="mb-4 text-right"><span class="bg-indigo-100 text-indigo-800 py-2 px-3 rounded-lg inline-block text-sm shadow-sm border border-indigo-200">${q}</span></div>`;
            input.value = "";
            showLoading();

            const sys = "Tu es un expert clinique 'Coach' pour infirmières en CHSLD. Réponds de façon pédagogique. Utilise un français québécois professionnel.";
            const res = await callGemini(q, sys);
            
            hideLoading();
            out.innerHTML += `<div class="mb-6 text-slate-700 bg-white p-0 rounded-lg prose prose-sm max-w-none"><div class="flex gap-3"><div class="flex-none pt-1"><div class="bg-teal-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-robot"></i></div></div><div>${marked.parse(res)}</div></div></div>`;
            out.scrollTop = out.scrollHeight;
        }

        // --- FEATURE 2 (IDEA 1): MALAISE 6087 GENERATOR ---
        async function generateMalaiseNote() {
            const text = document.getElementById('malaise-text').value;
            if(!text) return;
            document.getElementById('ai-output').innerHTML = "";
            showLoading();

            const prompt = `Voici des observations en vrac : "${text}". \n\nGénère une note structurée EXCLUSIVEMENT selon les titres du formulaire 6087. Si une info est manquante, laisse la section vide ou mets 'Non mentionné'. Sois précis et concis.`;
            const sys = "Tu es un assistant de documentation clinique expert du formulaire 6087. Tu ne fais que reformater les données.";
            
            const res = await callGemini(prompt, sys);
            hideLoading();
            document.getElementById('ai-output').innerHTML = `<div class="bg-slate-50 border border-slate-200 rounded p-6 shadow-inner prose prose-slate max-w-none text-sm">${marked.parse(res)}</div>`;
        }

        // --- FEATURE 3 (IDEA 2): TARGETED GUIDE ---
        async function generateGuide() {
            const problem = document.getElementById('guide-input').value;
            if(!problem) return;
            document.getElementById('ai-output').innerHTML = "";
            showLoading();

            const prompt = `Le résident présente : ${problem}. \n\nAgis comme un guide interactif. Liste les éléments SPÉCIFIQUES du formulaire 6087 à vérifier pour CE problème précis (ex: quel type de palpation, quels signes vitaux surveiller, quels signes de détresse chercher). Fais une checklist.`;
            const sys = "Tu es un mentor clinique. Tu aides à ne rien oublier lors de l'évaluation d'un malaise dominant.";

            const res = await callGemini(prompt, sys);
            hideLoading();
            document.getElementById('ai-output').innerHTML = `<div class="bg-blue-50 border border-blue-100 rounded p-4 shadow-sm prose prose-blue max-w-none text-sm">${marked.parse(res)}</div>`;
        }

        // --- FEATURE 4 (IDEA 5): SIMULATOR ---
        async function generateSimulation() {
            const type = document.getElementById('sim-type').value;
            document.getElementById('ai-output').innerHTML = "";
            showLoading();

            const prompt = `Génère un scénario clinique fictif complet pour un cas de : ${type}. \n\nPrésente le cas COMME SI on lisait un formulaire 6087 rempli (Anamnèse, PQRSTU, Vitaux, Examen physique détaillé). C'est pour la formation d'une infirmière.`;
            const sys = "Tu es un générateur de simulation clinique pour la formation.";

            const res = await callGemini(prompt, sys);
            hideLoading();
            document.getElementById('ai-output').innerHTML = `<div class="bg-purple-50 border border-purple-100 rounded p-6 shadow-sm prose prose-purple max-w-none text-sm relative"><span class="absolute top-2 right-2 text-xs font-bold text-purple-300 uppercase">Simulation</span>${marked.parse(res)}</div>`;
        }

        // --- FEATURE 5 (IDEA 4): TRIAGE AUTO (SIMULATION PTI) ---
        async function runSimulationPTI(source) {
            let context = "";
            if(source === 'chat') {
                // Grab text from chat
                context = document.getElementById('ai-output').innerText;
            } else if (source === 'malaise') {
                context = document.getElementById('malaise-text').value;
            } else if (source === 'manual') {
                context = document.getElementById('manual-text').value;
            }

            if(!context || context.length < 10) return alert("Pas assez d'information pour simuler un PTI.");

            // Open Modal if not open (case of button click from list)
            openAIModal();
            // We use the output window of the current tab
            showLoading();

            const prompt = `Basé sur ces données cliniques :\n"${context.substring(0, 1500)}..."\n\nAgis comme le 'Triage Automatique'. Suggère un PTI (Problème/Besoin prioritaire + Directives infirmières concrètes). Utilise le format : PROBLÈME : ... / DIRECTIVES : ...`;
            const sys = "Tu es un expert en élaboration de PTI (Plan Thérapeutique Infirmier). Tu analyses les données pour trouver les problèmes prioritaires.";

            const res = await callGemini(prompt, sys);
            hideLoading();
            
            // Append result cleanly
            const currentOut = document.getElementById('ai-output');
            const ptiBlock = `<div class="mt-4 border-t-2 border-indigo-100 pt-4"><div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg shadow-sm"><h4 class="font-bold text-indigo-800 text-xs uppercase mb-2"><i class="fa-solid fa-clipboard-list mr-2"></i>Suggestion PTI Automatique</h4><div class="prose prose-sm text-indigo-900">${marked.parse(res)}</div></div></div>`;
            currentOut.innerHTML += ptiBlock;
            currentOut.scrollTop = currentOut.scrollHeight;
        }

        // --- MANUAL NOTE ---
        async function generateManualNote() {
            const text = document.getElementById('manual-text').value;
            if(!text) return;
            document.getElementById('ai-output').innerHTML = "";
            showLoading();
            const res = await callGemini(`Rédige une note concise pour: "${text}"`, "Tu es experte en documentation.");
            hideLoading();
            document.getElementById('ai-output').innerHTML = `<div class="prose prose-sm">${marked.parse(res)}</div>`;
        }

        // --- UTILS ---
        function copyNote() {
            navigator.clipboard.writeText(document.getElementById('ai-output').innerText);
            alert("Copié !");
        }
        function downloadDOCX() {
            // Placeholder for Word generation logic (Same as before)
            alert("Génération Word (Fonction conservée du code précédent).");
        }
    </script>
</body>
</html>