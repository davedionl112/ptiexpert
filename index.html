<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Clinique - Assistant PTI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- SheetJS (Pour Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- DOCX & FileSaver -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        h1, h2, h3 { font-family: 'Roboto', sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        .role-badge {
            font-size: 0.60rem; padding: 2px 5px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-right: 6px; display: inline-block; min-width: 45px; text-align: center;
        }
        /* Role Colors */
        .role-pab { background-color: #dbeafe; color: #1e3a8a; border: 1px solid #93c5fd; } 
        .role-aux { background-color: #fce7f3; color: #831843; border: 1px solid #f9a8d4; } 
        .role-inf { background-color: #dcfce7; color: #14532d; border: 1px solid #86efac; } 
        .role-inf-aux { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #d8b4fe; }
        .role-aux-pab { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
        .role-all { background-color: #f1f5f9; color: #334151; border: 1px solid #cbd5e1; } 
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            width: 6px; height: 6px; background-color: #475569; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Dashboard Card Animation */
        .dash-card { transition: all 0.2s ease-in-out; }
        .dash-card:hover { transform: translateY(-3px); }
        
        /* Tool View Container */
        .tool-view { display: none; flex-direction: column; height: 100%; overflow: hidden; background-color: #fff; }
        .tool-view.active { display: flex; }

        /* Generated Directive Card */
        .gen-directive-card:hover { border-color: #0ea5e9; background-color: #f0f9ff; }
        
        /* Simulation Chat Bubbles */
        .sim-bubble-ai { background-color: #f3e8ff; border: 1px solid #d8b4fe; border-radius: 12px 12px 12px 0; padding: 10px; margin-bottom: 8px; max-width: 85%; align-self: flex-start; }
        .sim-bubble-user { background-color: #7e22ce; color: white; border-radius: 12px 12px 0 12px; padding: 10px; margin-bottom: 8px; max-width: 85%; align-self: flex-end; margin-left: auto; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-slate-50">

    <!-- Header -->
    <header class="bg-slate-800 text-white h-14 flex items-center justify-between px-4 shadow-lg z-50 flex-none">
        <div class="flex items-center gap-3">
            <button onclick="navigateTo('dashboard')" class="bg-slate-700 hover:bg-slate-600 p-1.5 rounded transition-colors text-teal-400" title="Retour Accueil">
                <i class="fa-solid fa-house text-lg"></i>
            </button>
            <div class="h-6 w-px bg-slate-600 mx-1"></div>
            <div class="flex items-center gap-2">
                <div class="bg-teal-600 p-1 rounded text-xs"><i class="fa-solid fa-user-nurse text-white"></i></div>
                <div>
                    <h1 class="text-sm font-bold leading-tight">STATION CLINIQUE <span class="text-teal-400">ASSISTANT</span></h1>
                    <p class="text-[9px] text-slate-400">Outil d'aide à la décision & Documentation <span class="text-slate-500 font-bold ml-1">(v7.5 Fixes)</span></p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span id="current-tool-label" class="hidden md:inline-block text-xs font-bold text-slate-400 uppercase tracking-wider mr-2">Tableau de bord</span>
            <button onclick="openSettings()" class="flex items-center gap-2 text-xs bg-slate-700 hover:bg-slate-600 text-yellow-400 hover:text-white px-3 py-2 rounded transition-colors border border-slate-600" title="Paramètres">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </header>

    <!-- CONTENT AREA -->
    <div id="main-container" class="flex-1 overflow-hidden relative bg-slate-100">

        <!-- 1. DASHBOARD VIEW -->
        <main id="view-dashboard" class="tool-view active overflow-y-auto p-4 sm:p-8 items-center bg-slate-50">
            <div class="max-w-5xl w-full space-y-8 mt-4 sm:mt-10 mx-auto">
                
                <div class="text-center space-y-2 mb-8">
                    <h2 class="text-3xl font-bold text-slate-800 tracking-tight">Bonjour, <span class="text-teal-600">Collègue</span></h2>
                    <p class="text-slate-500 text-lg">Sélectionnez un outil clinique pour commencer.</p>
                </div>

                <!-- Zone A: AI Tools -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center">
                        <i class="fa-solid fa-microchip mr-2 text-indigo-400"></i>Outils Intelligents
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        
                        <!-- Generator PTI -->
                        <button onclick="navigateTo('genpti')" class="dash-card p-4 rounded-lg border border-pink-100 bg-pink-50/50 hover:bg-pink-50 hover:shadow-md text-left group border-l-4 border-l-pink-400">
                            <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-wand-magic-sparkles text-2xl text-pink-600 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold bg-pink-100 text-pink-700 px-2 py-0.5 rounded border border-pink-200">Complet</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Générateur & Banque</h4>
                            <p class="text-xs text-slate-600 mt-1">Directives sur mesure & Bibliothèque.</p>
                        </button>

                        <!-- Coach -->
                        <button onclick="navigateTo('coach')" class="dash-card p-4 rounded-lg border border-indigo-100 bg-indigo-50/50 hover:bg-indigo-50 hover:shadow-md text-left group">
                            <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-user-doctor text-2xl text-indigo-600 group-hover:scale-110 transition-transform"></i>
                            </div>
                            <h4 class="font-bold text-slate-800">Coach Clinique</h4>
                            <p class="text-xs text-slate-600 mt-1">Questions procédures et médicaments.</p>
                        </button>
                        
                         <!-- Simulator -->
                        <button onclick="navigateTo('sim')" class="dash-card p-4 rounded-lg border border-purple-100 bg-purple-50/50 hover:bg-purple-50 hover:shadow-md text-left group">
                             <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-graduation-cap text-2xl text-purple-600 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200">Interactif</span>
                            </div>
                            <!-- RENOMMÉ -->
                            <h4 class="font-bold text-slate-800">Simulateur Malaise Dominant</h4>
                            <p class="text-xs text-slate-600 mt-1">Entraînement clinique interactif.</p>
                        </button>
                        
                        <!-- Malaise 6087 -->
                        <button onclick="navigateTo('malaise')" class="dash-card p-4 rounded-lg border border-teal-100 bg-teal-50/50 hover:bg-teal-50 hover:shadow-md text-left group">
                            <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-file-medical-alt text-2xl text-teal-600 group-hover:scale-110 transition-transform"></i>
                            </div>
                            <!-- RENOMMÉ -->
                            <h4 class="font-bold text-slate-800">Évaluation Malaise Dominant</h4>
                            <p class="text-xs text-slate-600 mt-1">Générateur de note complète d'évaluation d'un malaise dominant.</p>
                        </button>

                        <!-- Guide -->
                        <button onclick="navigateTo('guide')" class="dash-card p-4 rounded-lg border border-blue-100 bg-blue-50/50 hover:bg-blue-50 hover:shadow-md text-left group">
                             <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-list-check text-2xl text-blue-600 group-hover:scale-110 transition-transform"></i>
                            </div>
                            <h4 class="font-bold text-slate-800">Guide Ciblé</h4>
                            <p class="text-xs text-slate-600 mt-1">Aide-mémoire d'évaluation.</p>
                        </button>

                         <!-- Redactor -->
                        <button onclick="navigateTo('manual')" class="dash-card p-4 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 hover:shadow-md text-left group">
                             <div class="flex items-center justify-between mb-3">
                                <i class="fa-solid fa-pen-fancy text-2xl text-slate-600 group-hover:scale-110 transition-transform"></i>
                            </div>
                            <h4 class="font-bold text-slate-800">Rédacteur</h4>
                            <!-- DESCRIPTION MISE À JOUR -->
                            <p class="text-xs text-slate-600 mt-1">Reformulation en note abrégée.</p>
                        </button>
                    </div>
                </div>

                <!-- Zone B: PTI Access SUPPRIMÉ -->
                
                <p class="text-center text-[10px] text-slate-400 mt-12 font-mono">Usage Professionnel - Confidentiel</p>
            </div>
        </main>

        <!-- 2. PTI GENERATOR & BANK (MERGED VIEW) -->
        <div id="view-genpti" class="tool-view relative h-full">
            
            <!-- Fixed Header -->
            <div class="bg-pink-50 p-4 border-b border-pink-100 flex justify-between items-center flex-none z-20">
                <div class="flex items-center gap-2 text-pink-800">
                    <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
                    <h2 class="font-bold text-lg">Générateur & Banque PTI</h2>
                </div>
                <!-- BOUTON PANIER -->
                <button onclick="toggleSidebar()" class="bg-white border border-pink-200 text-pink-600 hover:bg-pink-100 text-xs font-bold px-3 py-1.5 rounded uppercase shadow-sm transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-clipboard-list"></i> Panier
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto bg-slate-50 relative">
                
                <!-- SECTION GENERATOR -->
                <div class="p-4 bg-white border-b border-slate-200">
                    <p class="text-xs text-slate-500 font-bold uppercase mb-2">Générateur IA : Décrivez le constat</p>
                    <textarea id="input-genpti" class="w-full border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-pink-500 h-24 shadow-inner" placeholder="Ex: Résident présente une rougeur au talon droit (stade 1) et se plaint de frottement dans ses souliers..."></textarea>
                    <button onclick="generateDirectives()" class="w-full mt-2 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 rounded shadow-sm text-sm transition-colors flex justify-center items-center gap-2">
                        <i class="fa-solid fa-gears"></i> Générer les Directives
                    </button>
                </div>
                
                <!-- Output AI -->
                <div id="output-genpti" class="p-6 bg-white min-h-[100px] border-b border-slate-200">
                    <div class="text-center text-slate-400 py-4">
                        <p class="text-xs">Les directives suggérées par l'IA apparaîtront ici.</p>
                    </div>
                </div>

                <!-- SECTION BANQUE (MOVED HERE) -->
                <div class="p-4 bg-slate-100 min-h-[500px]" id="main-library">
                    
                    <div class="flex items-center justify-between mb-4 mt-2">
                        <h3 class="font-bold text-slate-700 uppercase text-sm"><i class="fa-solid fa-database mr-2 text-slate-400"></i>Banque de Directives</h3>
                        <div id="db-status" class="text-xs font-bold text-slate-500 flex items-center">
                            <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-2 animate-pulse" id="status-dot"></span>
                            <span id="status-text">Initialisation...</span>
                        </div>
                    </div>

                    <!-- Filters - CORRECTION FUNCTION NAMES HERE (renderLibrary instead of filterLib) -->
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-4 flex flex-wrap gap-2 items-center sticky top-0 z-10">
                        <span class="text-[10px] uppercase font-bold text-slate-400 mr-2"><i class="fa-solid fa-filter mr-1"></i>Catégories:</span>
                        <button class="filter-btn active bg-slate-800 text-white text-xs px-3 py-1.5 rounded font-bold transition-colors" onclick="renderLibrary('all', this)">Tout</button>
                        <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="renderLibrary('scpd', this)">SCPD</button>
                        <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="renderLibrary('soins', this)">Soins</button>
                        <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="renderLibrary('clinique', this)">Médical</button>
                        <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="renderLibrary('infection', this)">Infections</button>
                        <button class="filter-btn bg-white text-slate-600 border border-slate-300 text-xs px-3 py-1.5 rounded font-bold hover:bg-slate-50" onclick="renderLibrary('palliatif', this)">Palliatif</button>
                    </div>

                    <!-- Grid Container -->
                    <div id="library-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 pb-12"></div>
                </div>
            </div>

            <!-- Sidebar (Integrated here) -->
            <!-- FIX: Z-INDEX 60 applied here -->
            <aside id="pti-sidebar" class="fixed inset-y-0 right-0 w-full md:w-[700px] bg-white shadow-2xl z-[60] transform translate-x-full transition-transform duration-300 flex flex-col border-l border-slate-200">
                <div class="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md flex-none">
                    <div>
                        <h3 class="font-bold text-sm uppercase"><i class="fa-solid fa-file-signature mr-2"></i> Panier PTI</h3>
                        <p class="text-[10px] text-slate-300">Prévisualisation</p>
                    </div>
                    <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 bg-white" id="pti-content">
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-300">
                        <i class="fa-solid fa-folder-plus text-6xl mb-4 text-slate-200"></i>
                        <p class="text-sm font-bold">Panier vide</p>
                    </div>
                    <div id="pti-visual-table" class="hidden">
                        <table class="pti-table shadow-sm">
                            <thead><tr><th style="width: 30%;">CONSTATS</th><th style="width: 70%;">DIRECTIVES</th></tr></thead>
                            <tbody id="pti-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t border-slate-200 flex-none space-y-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                    <button onclick="downloadDOCX()" class="w-full bg-blue-800 hover:bg-blue-700 text-white py-3 px-4 rounded text-sm font-bold flex justify-center items-center gap-2 shadow transition-colors">
                        <i class="fa-solid fa-file-word text-white"></i> Télécharger PTI (Word)
                    </button>
                </div>
            </aside>

            <!-- Floating Button -->
            <button onclick="toggleSidebar()" class="absolute bottom-6 right-6 bg-slate-800 text-white p-4 rounded-full shadow-lg z-30 hover:bg-slate-700 transition-transform hover:scale-105">
                 <i class="fa-solid fa-clipboard-list text-xl"></i>
                 <span id="pti-badge-float" class="absolute top-0 right-0 bg-red-500 text-white px-2 py-0.5 rounded-full text-[10px] hidden border border-white">0</span>
            </button>
        </div>

        <!-- 3. COACH VIEW -->
        <div id="view-coach" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
            <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-indigo-800">
                    <i class="fa-solid fa-user-doctor text-xl"></i>
                    <h2 class="font-bold text-lg">Coach Clinique</h2>
                </div>
            </div>
            <div id="output-coach" class="flex-1 overflow-y-auto p-6 space-y-4 bg-white scroll-smooth">
                <div class="text-center text-slate-400 mt-20">
                    <i class="fa-solid fa-robot text-4xl mb-3 text-indigo-200"></i>
                    <p>Prêt à vous assister.</p>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex gap-2">
                <input type="text" id="input-coach" class="flex-1 border border-slate-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm" placeholder="Question clinique..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" class="bg-indigo-600 text-white px-6 rounded-lg hover:bg-indigo-700 shadow-md font-bold"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
        
        <!-- 4. SIMULATOR VIEW (INTERACTIVE REFACTOR) -->
        <div id="view-sim" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
             <div class="bg-purple-50 p-4 border-b border-purple-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-purple-800">
                    <i class="fa-solid fa-graduation-cap text-xl"></i>
                    <!-- RENOMMÉ -->
                    <h2 class="font-bold text-lg">Simulateur Malaise Dominant</h2>
                </div>
                <button onclick="debriefSimulation()" id="btn-debrief" class="hidden bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold px-3 py-1.5 rounded uppercase shadow-sm">
                    <i class="fa-solid fa-file-contract mr-1"></i> Terminer & Rapport 6087
                </button>
            </div>
            
            <!-- Messages Area -->
            <div id="output-sim" class="flex-1 overflow-y-auto p-6 bg-white flex flex-col scroll-smooth">
                <div class="text-center text-slate-400 mt-20" id="sim-placeholder">
                    <i class="fa-solid fa-play-circle text-4xl mb-3 text-purple-200"></i>
                    <p>Choisissez un type de cas pour démarrer la mise en situation.</p>
                </div>
            </div>

            <!-- Controls Area -->
            <div class="p-4 bg-slate-50 border-t border-slate-200" id="sim-controls">
                 <!-- Start Screen -->
                 <div id="sim-start-panel" class="flex gap-2 items-center">
                     <select id="input-sim-type" class="flex-1 border border-slate-300 rounded p-3 text-sm bg-white shadow-sm cursor-pointer">
                        <option value="Malaise Cardiaque">Malaise Cardiaque</option>
                        <option value="Détresse Respiratoire">Détresse Respiratoire</option>
                        <option value="Suspicion AVC">AVC / Neuro</option>
                        <option value="Chute avec blessure">Chute avec blessure</option>
                        <option value="Douleur Abdominale Aiguë">Douleur Abdominale</option>
                        <option value="Hypoglycémie Sévère">Hypoglycémie</option>
                        <option value="Delirium Hyperactif">Delirium / SCPD</option>
                   </select>
                   <button onclick="startSimulation()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-3 rounded shadow-sm text-sm">
                       <i class="fa-solid fa-play mr-2"></i>Démarrer
                   </button>
                 </div>

                 <!-- Interaction Screen (Hidden initially) -->
                 <div id="sim-interaction-panel" class="hidden flex gap-2">
                    <input type="text" id="input-sim-chat" class="flex-1 border border-slate-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 shadow-sm" placeholder="Posez une question (PQRSTU) ou faites une action (ex: Je prends la TA)..." onkeypress="if(event.key==='Enter') sendSimInteraction()">
                    <button onclick="sendSimInteraction()" class="bg-purple-600 text-white px-6 rounded-lg hover:bg-purple-700 shadow-md font-bold"><i class="fa-solid fa-paper-plane"></i></button>
                 </div>
            </div>
        </div>

        <!-- 5. MALAISE 6087 VIEW -->
        <div id="view-malaise" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
            <div class="bg-teal-50 p-4 border-b border-teal-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-teal-800">
                    <i class="fa-solid fa-file-medical-alt text-xl"></i>
                    <!-- RENOMMÉ -->
                    <h2 class="font-bold text-lg">Évaluation Malaise Dominant</h2>
                </div>
                <button onclick="copyContent('output-malaise')" class="text-teal-600 hover:text-teal-800 text-xs font-bold uppercase"><i class="fa-regular fa-copy mr-1"></i> Copier</button>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-200">
                <textarea id="input-malaise" class="w-full border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-teal-500 h-24 shadow-inner" placeholder="Observations en vrac..."></textarea>
                <button onclick="generateMalaiseNote()" class="w-full mt-2 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded shadow-sm text-sm transition-colors">
                    <i class="fa-solid fa-file-contract mr-2"></i>Générer Note
                </button>
            </div>
            <div id="output-malaise" class="flex-1 overflow-y-auto p-6 bg-white prose prose-slate max-w-none text-sm leading-relaxed">
                <div class="text-center text-slate-400 mt-20"><p>Résultat ici.</p></div>
            </div>
        </div>

        <!-- 6. GUIDE VIEW -->
        <div id="view-guide" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
             <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-blue-800">
                    <i class="fa-solid fa-list-check text-xl"></i>
                    <h2 class="font-bold text-lg">Guide Ciblé</h2>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-200 flex gap-2">
                <input type="text" id="input-guide" class="flex-1 border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-blue-500 shadow-sm" placeholder="Problème (ex: Douleur thoracique...)" onkeypress="if(event.key==='Enter') generateGuide()">
                <button onclick="generateGuide()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded shadow-sm text-sm"><i class="fa-solid fa-search mr-2"></i>Quoi évaluer?</button>
            </div>
            <div id="output-guide" class="flex-1 overflow-y-auto p-6 bg-white prose prose-blue max-w-none text-sm leading-relaxed">
                <div class="text-center text-slate-400 mt-20"><p>Checklist ici.</p></div>
            </div>
        </div>

        <!-- 7. MANUAL REDACTOR VIEW -->
        <div id="view-manual" class="tool-view max-w-5xl mx-auto shadow-2xl border-x border-slate-200">
             <div class="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                <div class="flex items-center gap-2 text-slate-700">
                    <i class="fa-solid fa-pen-fancy text-xl"></i>
                    <h2 class="font-bold text-lg">Rédacteur</h2>
                </div>
                <button onclick="copyContent('output-manual')" class="text-slate-600 hover:text-slate-800 text-xs font-bold uppercase"><i class="fa-regular fa-copy mr-1"></i> Copier</button>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-200">
                <textarea id="input-manual" class="w-full border border-slate-300 rounded p-3 text-sm focus:ring-2 focus:ring-slate-500 h-24 shadow-inner" placeholder="Note narrative à reformuler..."></textarea>
                <button onclick="generateManualNote()" class="w-full mt-2 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 rounded shadow-sm text-sm">
                    <i class="fa-solid fa-pen-nib mr-2"></i>Rédiger Note Pro
                </button>
            </div>
            <div id="output-manual" class="flex-1 overflow-y-auto p-6 bg-white prose prose-slate max-w-none text-sm leading-relaxed">
                <div class="text-center text-slate-400 mt-20"><p>Note finale ici.</p></div>
            </div>
        </div>

    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative z-10">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Configuration API</h3>
            <input type="password" id="api-key-input" class="w-full border border-slate-300 rounded p-2 text-sm mb-4" placeholder="Clé API Google Gemini...">
            <div class="flex justify-end gap-2">
                <button onclick="closeSettings()" class="text-slate-500 hover:text-slate-700 font-bold px-4 py-2">Fermer</button>
                <button onclick="saveApiKey()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold px-4 py-2 rounded">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        // --- FALLBACKS ---
        const FALLBACK_CONSIGNES = "Tu es un assistant clinique expert pour les CHSLD. Ton est neutre et professionnel. Abréviations : TA, Pls, Sat, T, Resp.";
        const FALLBACK_6087 = "Structure 6087 : Anamnèse, Évolution, Examen Physique, Vitaux, Palpation, Interventions.";
        
        let database = []; 
        let currentPTI = {};
        let loadedPrompts = { global: "", form6087: "" };
        
        // Sim State
        let simHistory = [];

        document.addEventListener('DOMContentLoaded', async () => {
            loadDatabase();
            await loadExternalPrompts(); 
            const storedKey = localStorage.getItem('gemini_api_key');
            if(storedKey) document.getElementById('api-key-input').value = storedKey;
            navigateTo('dashboard');
        });

        async function loadExternalPrompts() {
            try {
                const r1 = await fetch('consignes_globales.txt'); loadedPrompts.global = r1.ok ? await r1.text() : FALLBACK_CONSIGNES;
                const r2 = await fetch('structure_6087.txt'); loadedPrompts.form6087 = r2.ok ? await r2.text() : FALLBACK_6087;
            } catch (e) { loadedPrompts.global = FALLBACK_CONSIGNES; loadedPrompts.form6087 = FALLBACK_6087; }
        }

        function navigateTo(viewName) {
            document.querySelectorAll('.tool-view').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('view-' + viewName);
            if(target) {
                target.classList.add('active');
                const labels = { 'dashboard': 'Tableau de bord', 'genpti': 'Générateur & Banque', 'coach': 'Coach', 'malaise': 'Note 6087', 'guide': 'Guide', 'manual': 'Rédacteur', 'sim': 'Simulateur' };
                document.getElementById('current-tool-label').innerText = labels[viewName] || 'Outil';
                // Si on navigue vers GENPTI, on s'assure que la librairie s'affiche
                if(viewName === 'genpti') renderLibrary('all');
            }
        }

        // --- SIMULATEUR INTERACTIF LOGIC ---
        
        async function startSimulation() {
            const type = document.getElementById('input-sim-type').value;
            const output = document.getElementById('output-sim');
            
            // Reset UI
            output.innerHTML = "";
            simHistory = [];
            document.getElementById('sim-start-panel').classList.add('hidden');
            document.getElementById('sim-interaction-panel').classList.remove('hidden');
            document.getElementById('sim-interaction-panel').classList.add('flex');
            document.getElementById('btn-debrief').classList.remove('hidden');

            showLoading('output-sim');

            // Premier Prompt System
            const sysPrompt = `CONTEXTE: Simulation clinique interactive pour infirmier en CHSLD.
            TYPE DE CAS: ${type}.
            
            TON RÔLE:
            1. Génère un patient fictif avec des données médicales cohérentes (Vitaux, Symptômes, Histoire) mais NE LES RÉVÈLE PAS TOUT DE SUITE. Garde-les en mémoire "cachée".
            2. Agis comme le patient (réponds aux questions) OU comme les instruments (donne le résultat si l'infirmier dit "Je prends la tension").
            3. Si l'utilisateur demande quelque chose d'impossible ou d'illogique, dis-le.
            
            DÉMARRAGE:
            Donne SEULEMENT une courte mise en situation (1 ou 2 phrases max) pour commencer l'interaction (ex: "La préposée t'appelle car...").
            Attends ensuite l'intervention de l'utilisateur.`;

            // On envoie
            const res = await callGemini("Démarre la simulation maintenant.", sysPrompt);
            
            // Save context
            simHistory.push({ role: "model", text: res });
            simHistory.push({ role: "system_instruction", text: sysPrompt }); 

            hideLoading();
            addSimBubble(res, 'ai');
        }

        async function sendSimInteraction() {
            const input = document.getElementById('input-sim-chat');
            const val = input.value;
            if(!val) return;

            // UI Update
            addSimBubble(val, 'user');
            input.value = "";
            showLoading('output-sim');

            // Build History Context
            let conversationContext = simHistory.filter(h => h.role !== "system_instruction").map(h => `${h.role === 'user' ? 'INFIRMIER' : 'SIMULATEUR'}: ${h.text}`).join('\n');
            
            const prompt = `${conversationContext}\n\nINFIRMIER: ${val}\n\nSIMULATEUR (Réponds court, agis comme le patient ou donne le résultat clinique):`;

            const res = await callGemini(prompt, "Tu es un simulateur de patient. Reste dans le personnage. Ne donne pas le diagnostic final, laisse l'infirmier chercher.");
            
            hideLoading();
            addSimBubble(res, 'ai');
            simHistory.push({ role: "user", text: val });
            simHistory.push({ role: "model", text: res });
        }

        async function debriefSimulation() {
            showLoading('output-sim');
            let conversationContext = simHistory.filter(h => h.role !== "system_instruction").map(h => `${h.role === 'user' ? 'INFIRMIER' : 'SIMULATEUR'}: ${h.text}`).join('\n');
            
            const prompt = `La simulation est terminée. Basé sur tous nos échanges ci-dessous, remplis le formulaire 6087 complet pour ce patient fictif.\n\nHISTORIQUE:\n${conversationContext}`;
            
            const res = await callGemini(prompt, loadedPrompts.form6087);
            
            hideLoading();
            const div = document.createElement('div');
            div.className = "bg-purple-50 border-2 border-purple-200 p-4 rounded-lg mt-4 mb-10 prose prose-sm max-w-none";
            div.innerHTML = `<h3 class="text-purple-800 font-bold uppercase mb-2">Rapport Final (6087)</h3>` + marked.parse(res);
            document.getElementById('output-sim').appendChild(div);
            document.getElementById('output-sim').scrollTop = document.getElementById('output-sim').scrollHeight;
            
            // Reset button state
            document.getElementById('btn-debrief').classList.add('hidden');
        }

        function addSimBubble(text, sender) {
            const container = document.getElementById('output-sim');
            const bubble = document.createElement('div');
            bubble.className = sender === 'ai' ? "sim-bubble-ai text-sm text-slate-700 shadow-sm" : "sim-bubble-user text-sm shadow-md font-medium";
            bubble.innerHTML = marked.parse(text);
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        // --- COMMON FUNCTIONS ---
        async function loadDatabase() {
            try {
                const response = await fetch('banque_pti.xlsx');
                if (!response.ok) throw new Error("Fichier non trouvé");
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                const tempMap = {};
                rawData.forEach(row => {
                    if(!row['ID_UNIQUE'] || !row['DIRECTIVE']) return;
                    const id = row['ID_UNIQUE'];
                    if(!tempMap[id]) tempMap[id] = { id, cat: row['CATEGORIE'] || 'divers', title: row['TITRE'] || '?', constats: row['CONSTATS'] ? row['CONSTATS'].split(',') : [], directives: [] };
                    tempMap[id].directives.push({ role: row['ROLE'] || 'ALL', text: row['DIRECTIVE'] });
                });
                database = Object.values(tempMap);
                document.getElementById('status-text').innerText = "Excel chargé";
                document.getElementById('status-dot').classList.replace('bg-yellow-400', 'bg-green-500');
            } catch (error) {
                database = [{ id: 'ex', cat: 'divers', title: 'Exemple', constats:[], directives:[{role:'INF', text:'Exemple'}]}]; 
                document.getElementById('status-text').innerText = "Mode Défaut";
                document.getElementById('status-dot').classList.replace('bg-yellow-400', 'bg-orange-500');
            }
        }

        function renderLibrary(filter, btn) {
            if(btn) { document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('bg-slate-800','text-white'); b.classList.add('bg-white','text-slate-600','border'); }); btn.classList.remove('bg-white','text-slate-600','border'); btn.classList.add('bg-slate-800','text-white'); }
            const container = document.getElementById('library-container');
            if(!container) return;
            container.innerHTML = '';
            (filter === 'all' ? database : database.filter(i => i.cat === filter)).forEach(item => {
                const list = item.directives.map((d,idx) => `<li class="directive-item p-2 border-b border-slate-50 last:border-0 text-xs text-slate-600 cursor-pointer flex" onclick="addDirective('${item.title.replace(/'/g,"\\'")}', '${d.text.replace(/'/g,"\\'")}', '${d.role}')"><span class="role-badge role-${d.role.toLowerCase().replace('/','-')}">${d.role}</span>${d.text}</li>`).join('');
                container.innerHTML += `<div class="bg-white p-3 rounded shadow-sm border border-slate-200"><h3 class="font-bold text-sm text-slate-800 mb-2">${item.title}</h3><ul class="max-h-40 overflow-y-auto">${list}</ul></div>`;
            });
        }

        function addDirective(prob, text, role) {
            if (!currentPTI[prob]) currentPTI[prob] = [];
            if (!currentPTI[prob].some(d => d.text === text)) {
                currentPTI[prob].push({ text, role });
                updateSidebar();
                const b = document.getElementById('pti-badge-float'); 
                b.classList.remove('hidden'); 
                b.innerText = Object.values(currentPTI).flat().length;
            }
        }

        function updateSidebar() {
            const tbody = document.getElementById('pti-table-body');
            tbody.innerHTML = '';
            Object.keys(currentPTI).forEach(p => {
                const dirs = currentPTI[p].map((d,i) => `<div class="flex justify-between border-b border-dashed border-slate-100 p-1 text-xs"><span><b class="text-[9px] mr-1">[${d.role}]</b>${d.text}</span><i class="fa-solid fa-trash text-slate-300 hover:text-red-500 cursor-pointer" onclick="removeDirective('${p}',${i})"></i></div>`).join('');
                tbody.innerHTML += `<tr><td class="font-bold text-xs bg-slate-50">${p}</td><td>${dirs}</td></tr>`;
            });
            document.getElementById('pti-visual-table').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }
        function removeDirective(p,i) { currentPTI[p].splice(i,1); if(currentPTI[p].length===0) delete currentPTI[p]; updateSidebar(); }
        function toggleSidebar() { document.getElementById('pti-sidebar').classList.toggle('translate-x-full'); }

        async function callGemini(prompt, specificContext) {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { openSettings(); return "⚠️ Clé API manquante. Veuillez configurer la clé."; }
            
            // Sécurité si les fichiers externes n'ont pas fini de charger
            const globalInst = loadedPrompts.global || FALLBACK_CONSIGNES;
            const fullSystem = `${globalInst}\n\nCONTEXTE SPÉCIFIQUE:\n${specificContext}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }], 
                        systemInstruction: { parts: [{ text: fullSystem }] } 
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error("Gemini API Error:", data.error);
                    return `⚠️ Erreur API (${data.error.code}): ${data.error.message}`;
                }
                
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Réponse vide reçue de l'IA.";

            } catch (e) { 
                console.error("Erreur de connexion:", e);
                return "⚠️ Erreur de connexion (Vérifiez votre internet ou si un bloqueur est actif)."; 
            }
        }

        function showLoading(id) { const el = document.getElementById(id); const l = document.createElement('div'); l.className="text-center py-4 loading-indicator"; l.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span>'; el.appendChild(l); el.scrollTop = el.scrollHeight; }
        function hideLoading() { document.querySelectorAll('.loading-indicator').forEach(e => e.remove()); }
        
        // --- UPDATED GENERATE DIRECTIVES (Fix format & Roles) ---
        async function generateDirectives() {
            const text = document.getElementById('input-genpti').value;
            if(!text) return;
            const output = document.getElementById('output-genpti');
            output.innerHTML = "";
            showLoading('output-genpti');

            // STRICTER PROMPT FOR PARSING
            const prompt = `CONSTAT/SITUATION: "${text}"\n\nGénère 3 à 5 directives infirmières pertinentes pour un PTI.
            
            FORMAT STRICT (Une directive par ligne) :
            ROLE | Directive
            
            RÔLES AUTORISÉS UNIQUEMENT :
            - INF
            - AUX
            - PAB
            - INF/AUX
            - AUX/PAB
            
            EXEMPLE DE RÉPONSE ATTENDUE :
            INF | Évaluer la douleur Q4H
            PAB | Aide à la marche x 1
            INF/AUX | Surveiller état cutané
            
            IMPORTANT: Ne mets pas de tirets, pas de markdown, juste le texte brut.`;

            const res = await callGemini(prompt, "Tu es un générateur de directives PTI. Respecte strictement le format demandé.");
            hideLoading();
            
            output.innerHTML = "";
            const lines = res.split('\n');
            let found = false;
            
            lines.forEach(line => {
                // Nettoyage agressif : ignore les lignes de tableau markdown
                if(line.includes('---') || line.toLowerCase().includes('role | directive')) return;

                if(line.includes('|')) {
                    const parts = line.split('|');
                    // Clean unwanted characters like ** or spaces
                    let role = parts[0].trim().replace(/[*\[\]-]/g, ''); 
                    const dir = parts[1].trim();
                    
                    // Normalize Roles (optional, but ensures CSS match)
                    role = role.toUpperCase();
                    
                    if(role && dir) {
                        found = true;
                        const constLabel = text.length > 30 ? text.substring(0,30) + "..." : text;
                        
                        // Map specific CSS classes for new roles
                        let roleClass = "role-all"; // Default
                        if (role === "INF") roleClass = "role-inf";
                        else if (role === "AUX") roleClass = "role-aux";
                        else if (role === "PAB") roleClass = "role-pab";
                        else if (role === "INF/AUX") roleClass = "role-inf-aux";
                        else if (role === "AUX/PAB") roleClass = "role-aux-pab";

                        const card = document.createElement('div');
                        card.className = "gen-directive-card bg-white border border-slate-200 p-3 rounded mb-2 cursor-pointer shadow-sm transition-all flex items-start gap-3";
                        card.innerHTML = `<div class="role-badge ${roleClass} mt-1">${role}</div><div class="flex-1 text-sm text-slate-700">${dir}</div><div class="text-teal-500"><i class="fa-solid fa-plus-circle"></i></div>`;
                        card.onclick = () => { 
                            addDirective("Constat Généré: " + constLabel, dir, role);
                            card.classList.add('bg-teal-50', 'border-teal-200');
                            card.innerHTML = `<div class="role-badge ${roleClass} mt-1">${role}</div><div class="flex-1 text-sm text-slate-700 italic line-through opacity-50">${dir}</div><div class="text-teal-600 font-bold text-xs">AJOUTÉ</div>`;
                        };
                        output.appendChild(card);
                    }
                }
            });
            
            if(!found) output.innerHTML = `<div class="p-4 bg-yellow-50 text-slate-700 text-sm border-l-4 border-yellow-400"><strong>Note:</strong> L'IA n'a pas respecté le format strict, voici la réponse brute :<br><br>${marked.parse(res)}</div>`;
        }

        async function generateMalaiseNote() {
            const t = document.getElementById('input-malaise').value;
            showLoading('output-malaise');
            const res = await callGemini(`Observations: ${t}. Remplis le formulaire 6087.`, loadedPrompts.form6087);
            hideLoading();
            document.getElementById('output-malaise').innerHTML = `<div class="bg-slate-50 border border-slate-200 rounded p-6 shadow-inner">${marked.parse(res)}</div>`;
        }

        async function generateGuide() {
            const t = document.getElementById('input-guide').value;
            showLoading('output-guide');
            const res = await callGemini(`Problème: ${t}. Liste quoi évaluer selon le 6087.`, "Tu es un guide clinique.");
            hideLoading();
            document.getElementById('output-guide').innerHTML = `<div class="bg-blue-50 border border-blue-100 rounded p-4 shadow-sm">${marked.parse(res)}</div>`;
        }

        async function generateManualNote() {
            const t = document.getElementById('input-manual').value;
            showLoading('output-manual');
            const res = await callGemini(`Reformule pro: ${t}`, "Tu es expert en documentation.");
            hideLoading();
            document.getElementById('output-manual').innerHTML = `<div class="bg-white border border-slate-200 p-4 rounded shadow-sm">${marked.parse(res)}</div>`;
        }

        async function sendChat() {
            const q = document.getElementById('input-coach').value;
            if(!q) return;
            const out = document.getElementById('output-coach');
            out.innerHTML += `<div class="mb-4 text-right"><span class="bg-indigo-100 text-indigo-800 py-2 px-3 rounded text-sm">${q}</span></div>`;
            document.getElementById('input-coach').value = "";
            showLoading('output-coach');
            const res = await callGemini(q, "Tu es un coach clinique.");
            hideLoading();
            out.innerHTML += `<div class="mb-6 bg-white p-4 rounded border border-slate-200 prose prose-sm max-w-none">${marked.parse(res)}</div>`;
            out.scrollTop = out.scrollHeight;
        }

        function copyContent(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("Copié!"); }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); }
        function saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value); closeSettings(); }
        
        function downloadDOCX() {
             const problems = Object.keys(currentPTI);
            if (problems.length === 0) return alert("Le panier PTI est vide.");
            const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, TextRun, HeadingLevel, AlignmentType } = docx;
            const rows = [ new TableRow({ children: [ new TableCell({ children: [new Paragraph({ text: "CONSTATS", bold: true })], width: { size: 35, type: WidthType.PERCENTAGE }, shading: { fill: "f3f4f6" } }), new TableCell({ children: [new Paragraph({ text: "DIRECTIVES", bold: true })], width: { size: 65, type: WidthType.PERCENTAGE }, shading: { fill: "f3f4f6" } }) ] }) ];
            for (const prob of problems) {
                const directives = currentPTI[prob];
                const dirParagraphs = directives.map(d => new Paragraph({ children: [ new TextRun({ text: d.text + " ", size: 22 }), new TextRun({ text: `[${d.role}]`, bold: true, size: 18, color: "666666" }) ], bullet: { level: 0 } }));
                rows.push(new TableRow({ children: [ new TableCell({ children: [new Paragraph({ text: prob, bold: true })], width: { size: 35, type: WidthType.PERCENTAGE } }), new TableCell({ children: dirParagraphs, width: { size: 65, type: WidthType.PERCENTAGE } }) ] }));
            }
            const doc = new Document({ sections: [{ children: [ new Paragraph({ text: "PLAN THÉRAPEUTIQUE INFIRMIER", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 100 } }), new Table({ rows: rows, width: { size: 100, type: WidthType.PERCENTAGE } }) ] }] });
            Packer.toBlob(doc).then(blob => { saveAs(blob, "PTI.docx"); });
        }
    </script>
</body>
</html>